<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Openstack Masakari task流程源码分析 | 后端云</title>
  <meta name="keywords" content=" VM HA , Openstack , Masakari , 源码分析 ">
  <meta name="description" content="Openstack Masakari task流程源码分析 | 后端云">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="description" content="penstack linux kernel NFV OPNFV MANO OPEN-O 虚拟机 容器 裸机 微服务 lambda计算 kubernetes 异构计算 人工智能">
<meta property="og:type" content="website">
<meta property="og:title" content="categories">
<meta property="og:url" content="https://www.backendcloud.cn/categories/index.html">
<meta property="og:site_name" content="后端云">
<meta property="og:description" content="penstack linux kernel NFV OPNFV MANO OPEN-O 虚拟机 容器 裸机 微服务 lambda计算 kubernetes 异构计算 人工智能">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2017-01-27T22:06:06.000Z">
<meta property="article:modified_time" content="2022-04-02T00:42:52.642Z">
<meta property="article:author" content="后端云">
<meta property="article:tag" content="penstack linux kernel NFV OPNFV MANO OPEN-O 虚拟机 容器 裸机 微服务 lambda计算 kubernetes 异构计算 人工智能">
<meta name="twitter:card" content="summary">


<link rel="icon" href="/img/avatar.jpg">

<link href="/css/style.css?v=1.1.0" rel="stylesheet">

<link href="/css/hl_theme/zenbum.css?v=1.1.0" rel="stylesheet">

<link href="//cdn.jsdelivr.net/npm/animate.css@4.1.0/animate.min.css" rel="stylesheet">

<script src="//cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js"></script>
<script src="/js/titleTip.js?v=1.1.0" ></script>

<script src="//cdn.jsdelivr.net/npm/highlightjs@9.16.2/highlight.pack.min.js"></script>
<script>
    hljs.initHighlightingOnLoad();
</script>

<script src="//cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.js"></script>



<script src="//cdn.jsdelivr.net/npm/jquery.cookie@1.4.1/jquery.cookie.min.js" ></script>

<script src="/js/iconfont.js?v=1.1.0" ></script>

<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?2858b2d509d28416712739c9a6a31204";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>
<meta name="generator" content="Hexo 5.2.0"></head>
<div style="display: none">
  <input class="theme_disqus_on" value="false">
  <input class="theme_preload_comment" value="">
  <input class="theme_blog_path" value="">
  <input id="theme_shortcut" value="true" />
  <input id="theme_highlight_on" value="true" />
  <input id="theme_code_copy" value="true" />
</div>



<body>
<aside class="nav">
    <div class="nav-left">
        <a href="/" class="avatar_target">
    <img class="avatar" src="/img/avatar.jpg" />
</a>
<div class="author">
    <span>后端云</span>
</div>

<div class="icon">
    
</div>




<ul>
    <li><div class="all active" data-rel="全部文章">全部文章<small>(109)</small></div></li>
    
        
            
            <li><div data-rel="边缘云">边缘云<small>(3)</small></div>
                
            </li>
            
        
    
        
            
            <li><div data-rel="动态">动态<small>(1)</small></div>
                
            </li>
            
        
    
        
            
            <li><div data-rel="基础篇">基础篇<small>(2)</small></div>
                
            </li>
            
        
    
        
            
            <li><div data-rel="敏捷">敏捷<small>(3)</small></div>
                
            </li>
            
        
    
        
            
            <li><div data-rel="生活">生活<small>(1)</small></div>
                
            </li>
            
        
    
        
            
            <li><div data-rel="业界">业界<small>(6)</small></div>
                
            </li>
            
        
    
        
            
            <li><div data-rel="云原生">云原生<small>(14)</small></div>
                
            </li>
            
        
    
        
            
            <li><div data-rel="智能云">智能云<small>(5)</small></div>
                
            </li>
            
        
    
        
            
            <li><div data-rel="自动化">自动化<small>(2)</small></div>
                
            </li>
            
        
    
        
            
            <li><div data-rel="Collectd">Collectd<small>(1)</small></div>
                
            </li>
            
        
    
        
            
            <li><div data-rel="Java">Java<small>(3)</small></div>
                
            </li>
            
        
    
        
            
            <li><div data-rel="NFV">NFV<small>(16)</small></div>
                
            </li>
            
        
    
        
            
            <li><div data-rel="Openstack_dev">Openstack_dev<small>(6)</small></div>
                
            </li>
            
        
    
        
            
            <li><div data-rel="Openstack_op">Openstack_op<small>(29)</small></div>
                
            </li>
            
        
    
        
            
            <li><div data-rel="Python">Python<small>(1)</small></div>
                
            </li>
            
        
    
        
            
            <li><div data-rel="Tools">Tools<small>(14)</small></div>
                
            </li>
            
        
    
</ul>
<div class="left-bottom">
    <div class="menus">
    
    
    
    
    </div>
    <div></div>
</div>
<input type="hidden" id="yelog_site_posts_number" value="109">

<div style="display: none">
    <span id="busuanzi_value_site_uv"></span>
    <span id="busuanzi_value_site_pv"></span>
</div>

    </div>
    <div class="nav-right">
        <div class="friends-area">
    <div class="friends-title">
        友情链接
        <i class="iconfont icon-left"></i>
    </div>
    <div class="friends-content">
        <ul>
            
        </ul>
    </div>
</div>
        <div class="title-list">
    <div class="right-top">
        <div id="default-panel">
            <i class="iconfont icon-search" data-title="搜索 快捷键 i"></i>
            <div class="right-title">全部文章</div>
            <i class="iconfont icon-file-tree" data-title="切换到大纲视图 快捷键 w"></i>
        </div>
        <div id="search-panel">
            <i class="iconfont icon-left" data-title="返回"></i>
            <input id="local-search-input" />
            <label class="border-line" for="input"></label>
            <i class="iconfont icon-case-sensitive" data-title="大小写敏感"></i>
            <i class="iconfont icon-tag" data-title="标签"></i>
        </div>
        <div id="outline-panel" style="display: none">
            <div class="right-title">大纲</div>
            <i class="iconfont icon-list" data-title="切换到文章列表"></i>
        </div>
    </div>

    <div class="tags-list">
    <input id="tag-search" />
    <div class="tag-wrapper">
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>4G</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>5G</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>安装</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>边缘计算</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>边缘云</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>参与</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>插件</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>产业趋势</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>产业需求</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>成熟</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>持续集成</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>存储</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>多级跳转</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>孵化</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>工具</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>管理体制</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>广告</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>归档</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>华为</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>会员</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>会员制</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>集成</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>脚本</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>开发</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>开源</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>美国</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>目标</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>内存</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>配置</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>破解</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>热迁移</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>日本</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>上游关系</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>生命周期</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>生态</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>隧道</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>提案</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>效率</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>印象笔记国内版</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>源码分析</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>云硬盘</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>云原生</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>运营商</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>中心云</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>转发</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>自动化测试</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>子项目</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>aggregation</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>AI</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>ansible</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>API</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>async</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>available zone</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>Board</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>bug</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>Bug</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>Capability</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>CentOS7.7</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>centos8</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>CI/CD</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>Collectd</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>CPU</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>cpu-pinning</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>cpu绑定</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>cpu核绑定</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>Cyborg</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>devops</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>docker</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>Doctor</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>DSL</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>ETSI</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>evacuate</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>Fluentd</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>FPGA</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>Game</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>gerrit</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>git</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>git flow</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>Github Action</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>goland</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>google</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>Gossip</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>GPU</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>HA</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>hosts</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>https</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>Huge Page</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>Idea</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>ideaIU</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>InfluxDB</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>Intel Clear Container</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>iperf3</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>Java</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>JDK</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>jenkins</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>jetbrains</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>JIRA</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>K3S</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>k8s</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>K8S</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>Kata Containers</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>KSM</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>kubeconfig</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>KubeEdge</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>Kubernetes</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>Kubernetes API</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>Load Balance</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>LVS</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>masakari</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>Masakari</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>NB-IoT</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>Notion</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>Nova</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>nova-scheduler</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>noVNC</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>numa</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>NUMA</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>Ocata</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>OOMkilled</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>Openstack</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>Openstack Ocata</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>Openstack Pike</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>openstack token管理</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>OpenYurt</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>OPNFV Prediction</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>ovs</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>parameter</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>passthrough</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>PCI</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>Pike</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>placement</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>PLG</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>Pod</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>POWER</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>privileged</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>Prometheus</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>pycharm</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>PyCharm</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>Python</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>qemu</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>QQ</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>Raft</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>RAID</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>React</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>Region</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>RT</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>selinux</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>serverless</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>Serverless</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>Serverwalker</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>Service</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>spring-boot</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>SR-IOV</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>sriov</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>Stein</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>Switch</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>SYS_TIME</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>systemd</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>template</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>Tools</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>TSC</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>tunnel</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>Typora</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>vdbench</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>vim</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>Vitrage</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>VM HA</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>vnc</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>VNFD</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>WebStorm</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>widget</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>windows</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>xshell</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>yum</a>
            </li>
        
    </div>

</div>

    
    <nav id="title-list-nav">
        
        <a  class="全部文章 "
           href="/2022/04/02/20220401/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="20220401">20220401</span>
            <span class="post-date" title="2022-04-02 13:22:41">2022/04/02</span>
        </a>
        
        <a  class="全部文章 Java "
           href="/2022/03/25/spring-boot-async-demo/"
           data-tag="spring-boot,async"
           data-author="" >
            <span class="post-title" title="spring-boot异步的example">spring-boot异步的example</span>
            <span class="post-date" title="2022-03-25 11:24:27">2022/03/25</span>
        </a>
        
        <a  class="全部文章 Tools "
           href="/2022/02/25/github-action-demo/"
           data-tag="CI/CD,Github Action,React"
           data-author="" >
            <span class="post-title" title="试用Github Action CI/CD流程（创建一个React项目，并打包部署）">试用Github Action CI/CD流程（创建一个React项目，并打包部署）</span>
            <span class="post-date" title="2022-02-25 11:54:20">2022/02/25</span>
        </a>
        
        <a  class="全部文章 Tools "
           href="/2022/01/06/notion-widget/"
           data-tag="Notion,widget"
           data-author="" >
            <span class="post-title" title="Notion的页面插入小控件Widget">Notion的页面插入小控件Widget</span>
            <span class="post-date" title="2022-01-06 11:06:12">2022/01/06</span>
        </a>
        
        <a  class="全部文章 Tools "
           href="/2022/01/06/notion/"
           data-tag="Notion,印象笔记国内版"
           data-author="" >
            <span class="post-title" title="Notion笔记和印象笔记同时使用的分工">Notion笔记和印象笔记同时使用的分工</span>
            <span class="post-date" title="2022-01-06 10:28:42">2022/01/06</span>
        </a>
        
        <a  class="全部文章 生活 "
           href="/2022/01/06/switch/"
           data-tag="Switch,Game"
           data-author="" >
            <span class="post-title" title="Switch游戏推荐">Switch游戏推荐</span>
            <span class="post-date" title="2022-01-06 09:58:49">2022/01/06</span>
        </a>
        
        <a  class="全部文章 Tools "
           href="/2021/12/16/idea-plugin/"
           data-tag="Idea,插件"
           data-author="" >
            <span class="post-title" title="Idea 插件推荐">Idea 插件推荐</span>
            <span class="post-date" title="2021-12-16 17:48:09">2021/12/16</span>
        </a>
        
        <a  class="全部文章 云原生 "
           href="/2021/12/01/PLG/"
           data-tag="Kubernetes,Pod,PLG"
           data-author="" >
            <span class="post-title" title="PLG 实现 Kubernetes Pod 日志收集和展示">PLG 实现 Kubernetes Pod 日志收集和展示</span>
            <span class="post-date" title="2021-12-01 17:48:46">2021/12/01</span>
        </a>
        
        <a  class="全部文章 云原生 "
           href="/2021/11/30/pod-log-collect/"
           data-tag="Kubernetes,Pod,Fluentd"
           data-author="" >
            <span class="post-title" title="Fluentd 实现 Kubernetes Pod 日志收集">Fluentd 实现 Kubernetes Pod 日志收集</span>
            <span class="post-date" title="2021-11-30 16:36:50">2021/11/30</span>
        </a>
        
        <a  class="全部文章 Java "
           href="/2021/11/23/java-memo/"
           data-tag="Java"
           data-author="" >
            <span class="post-title" title="Java项目开发中的点滴记录（1）">Java项目开发中的点滴记录（1）</span>
            <span class="post-date" title="2021-11-23 15:04:04">2021/11/23</span>
        </a>
        
        <a  class="全部文章 Java "
           href="/2021/11/23/jdkbug/"
           data-tag="JDK,bug"
           data-author="" >
            <span class="post-title" title="JDK bug - Encrypt Private Key failed  unrecognized algorithm name  PBEWithSHA1AndDESede">JDK bug - Encrypt Private Key failed  unrecognized algorithm name  PBEWithSHA1AndDESede</span>
            <span class="post-date" title="2021-11-23 14:22:24">2021/11/23</span>
        </a>
        
        <a  class="全部文章 云原生 "
           href="/2021/09/28/kubernetes-api/"
           data-tag="边缘计算,Kubernetes API,云原生,中心云,边缘云"
           data-author="" >
            <span class="post-title" title="在产品开发中调用Kubernetes API接口遇到的几个问题">在产品开发中调用Kubernetes API接口遇到的几个问题</span>
            <span class="post-date" title="2021-09-28 17:25:28">2021/09/28</span>
        </a>
        
        <a  class="全部文章 Tools "
           href="/2021/09/26/git-flow/"
           data-tag="git flow,git"
           data-author="" >
            <span class="post-title" title="开始尝试使用git flow工作流">开始尝试使用git flow工作流</span>
            <span class="post-date" title="2021-09-26 15:32:59">2021/09/26</span>
        </a>
        
        <a  class="全部文章 Tools "
           href="/2021/09/15/typora-auto-numbering/"
           data-tag="Typora,Tools"
           data-author="" >
            <span class="post-title" title="Mac版Typora 标题自动编号">Mac版Typora 标题自动编号</span>
            <span class="post-date" title="2021-09-15 17:36:23">2021/09/15</span>
        </a>
        
        <a  class="全部文章 云原生 "
           href="/2021/09/13/create-kubeconfig/"
           data-tag="kubeconfig"
           data-author="" >
            <span class="post-title" title="云管平台创建资源池租户功能的实现">云管平台创建资源池租户功能的实现</span>
            <span class="post-date" title="2021-09-13 14:22:18">2021/09/13</span>
        </a>
        
        <a  class="全部文章 云原生 "
           href="/2021/08/10/kubernetes-iperf3-2/"
           data-tag="Kubernetes,iperf3,Service"
           data-author="" >
            <span class="post-title" title="iperf3测试Kubernetes Service的四层性能（下）">iperf3测试Kubernetes Service的四层性能（下）</span>
            <span class="post-date" title="2021-08-10 07:06:01">2021/08/10</span>
        </a>
        
        <a  class="全部文章 云原生 "
           href="/2021/08/09/kubernetes-iperf3/"
           data-tag="Kubernetes,iperf3,Service"
           data-author="" >
            <span class="post-title" title="iperf3测试Kubernetes Service的四层性能（上）">iperf3测试Kubernetes Service的四层性能（上）</span>
            <span class="post-date" title="2021-08-09 17:06:01">2021/08/09</span>
        </a>
        
        <a  class="全部文章 边缘云 "
           href="/2021/03/12/edge2021/"
           data-tag="serverless,边缘计算,5G,4G,NB-IoT,AI"
           data-author="" >
            <span class="post-title" title="边缘计算2021年展望">边缘计算2021年展望</span>
            <span class="post-date" title="2021-03-12 09:41:42">2021/03/12</span>
        </a>
        
        <a  class="全部文章 Tools "
           href="/2021/03/11/jetbrains-mac-m1/"
           data-tag="jetbrains,goland,ideaIU,pycharm,WebStorm,破解"
           data-author="" >
            <span class="post-title" title="jetbrains macbook m1版全家桶破解">jetbrains macbook m1版全家桶破解</span>
            <span class="post-date" title="2021-03-11 17:01:57">2021/03/11</span>
        </a>
        
        <a  class="全部文章 边缘云 "
           href="/2021/01/26/edge-think/"
           data-tag="serverless,边缘计算,FPGA,GPU"
           data-author="" >
            <span class="post-title" title="边缘计算的几点思考">边缘计算的几点思考</span>
            <span class="post-date" title="2021-01-26 17:11:34">2021/01/26</span>
        </a>
        
        <a  class="全部文章 边缘云 "
           href="/2021/01/21/kubernetes2edge/"
           data-tag="Kubernetes,K8S,K3S,OpenYurt,KubeEdge"
           data-author="" >
            <span class="post-title" title="K3S, OpenYurt, KubeEdge 主要差异">K3S, OpenYurt, KubeEdge 主要差异</span>
            <span class="post-date" title="2021-01-21 16:47:45">2021/01/21</span>
        </a>
        
        <a  class="全部文章 云原生 "
           href="/2020/05/27/k8s-op/"
           data-tag="k8s"
           data-author="" >
            <span class="post-title" title="k8s常用操作">k8s常用操作</span>
            <span class="post-date" title="2020-05-27 17:32:08">2020/05/27</span>
        </a>
        
        <a  class="全部文章 云原生 "
           href="/2020/05/22/k8s-cpubond/"
           data-tag="Kubernetes,k8s,cpu核绑定"
           data-author="" >
            <span class="post-title" title="k8s支持容器核绑定">k8s支持容器核绑定</span>
            <span class="post-date" title="2020-05-22 16:24:44">2020/05/22</span>
        </a>
        
        <a  class="全部文章 云原生 "
           href="/2020/05/22/k8s-capability/"
           data-tag="Kubernetes,k8s,Capability,SYS_TIME"
           data-author="" >
            <span class="post-title" title="k8s支持Capability机制">k8s支持Capability机制</span>
            <span class="post-date" title="2020-05-22 15:18:59">2020/05/22</span>
        </a>
        
        <a  class="全部文章 云原生 "
           href="/2020/05/22/pod-mem/"
           data-tag="Kubernetes,k8s,OOMkilled,privileged"
           data-author="" >
            <span class="post-title" title="k8s OOMkilled超出内存限制的容器">k8s OOMkilled超出内存限制的容器</span>
            <span class="post-date" title="2020-05-22 13:52:15">2020/05/22</span>
        </a>
        
        <a  class="全部文章 云原生 "
           href="/2020/04/16/centos7-7-k8s-3nodes-prometheus/"
           data-tag="CentOS7.7,k8s,Prometheus"
           data-author="" >
            <span class="post-title" title="CentOS7.7部署k8s + Prometheus（1 master + 2 node）">CentOS7.7部署k8s + Prometheus（1 master + 2 node）</span>
            <span class="post-date" title="2020-04-16 13:46:34">2020/04/16</span>
        </a>
        
        <a  class="全部文章 云原生 "
           href="/2020/04/13/centos7-7-k8s-7nodes/"
           data-tag="CentOS7.7,k8s"
           data-author="" >
            <span class="post-title" title="CentOS7.7部署k8s（3 master + 3 node + 1 client）">CentOS7.7部署k8s（3 master + 3 node + 1 client）</span>
            <span class="post-date" title="2020-04-13 13:46:34">2020/04/13</span>
        </a>
        
        <a  class="全部文章 云原生 "
           href="/2020/04/10/centos7-7-k8s-3nodes/"
           data-tag="CentOS7.7,k8s"
           data-author="" >
            <span class="post-title" title="CentOS7.7部署k8s（1 master + 2 node）">CentOS7.7部署k8s（1 master + 2 node）</span>
            <span class="post-date" title="2020-04-10 13:46:34">2020/04/10</span>
        </a>
        
        <a  class="全部文章 云原生 "
           href="/2020/03/16/centos8installdocker/"
           data-tag="docker,centos8"
           data-author="" >
            <span class="post-title" title="CentOS 8.0 安装docker 报错：Problem: package docker-ce-3:19.03.8-3.el7.x86_64 requires containerd.io &gt;= 1.2.2-3">CentOS 8.0 安装docker 报错：Problem: package docker-ce-3:19.03.8-3.el7.x86_64 requires containerd.io &gt;= 1.2.2-3</span>
            <span class="post-date" title="2020-03-16 16:04:21">2020/03/16</span>
        </a>
        
        <a  class="全部文章 Openstack_dev "
           href="/2020/01/09/masakari-task-code/"
           data-tag="VM HA,Openstack,Masakari,源码分析"
           data-author="" >
            <span class="post-title" title="Openstack Masakari task流程源码分析">Openstack Masakari task流程源码分析</span>
            <span class="post-date" title="2020-01-09 09:18:53">2020/01/09</span>
        </a>
        
        <a  class="全部文章 Openstack_op "
           href="/2020/01/01/openstackopmemo4/"
           data-tag="Openstack,devops"
           data-author="" >
            <span class="post-title" title="Openstack运维常见问题记录(4)">Openstack运维常见问题记录(4)</span>
            <span class="post-date" title="2020-01-01 20:28:32">2020/01/01</span>
        </a>
        
        <a  class="全部文章 Openstack_op "
           href="/2019/09/20/stein-deploy-problem/"
           data-tag="Stein"
           data-author="" >
            <span class="post-title" title="Openstack Stein 部署遇到的问题">Openstack Stein 部署遇到的问题</span>
            <span class="post-date" title="2019-09-20 18:49:06">2019/09/20</span>
        </a>
        
        <a  class="全部文章 Tools "
           href="/2019/08/28/jetbrains/"
           data-tag="jetbrains,goland,ideaIU,pycharm,WebStorm,破解"
           data-author="" >
            <span class="post-title" title="jetbrains windows版全家桶破解">jetbrains windows版全家桶破解</span>
            <span class="post-date" title="2019-08-28 15:15:39">2019/08/28</span>
        </a>
        
        <a  class="全部文章 Tools "
           href="/2019/08/27/tunnel/"
           data-tag="xshell,tunnel,隧道,工具"
           data-author="" >
            <span class="post-title" title="xshell隧道转发的三种类型">xshell隧道转发的三种类型</span>
            <span class="post-date" title="2019-08-27 15:25:01">2019/08/27</span>
        </a>
        
        <a  class="全部文章 业界 "
           href="/2019/06/15/huaweijpqa/"
           data-tag="华为,日本,美国"
           data-author="" >
            <span class="post-title" title="任正非5月18日接受日本媒体采访的中文纪要">任正非5月18日接受日本媒体采访的中文纪要</span>
            <span class="post-date" title="2019-06-15 13:02:34">2019/06/15</span>
        </a>
        
        <a  class="全部文章 业界 "
           href="/2019/05/21/huaweiyun/"
           data-tag="华为"
           data-author="" >
            <span class="post-title" title="华为云可能也要被美国釜底抽薪">华为云可能也要被美国釜底抽薪</span>
            <span class="post-date" title="2019-05-21 11:52:58">2019/05/21</span>
        </a>
        
        <a  class="全部文章 业界 "
           href="/2019/05/20/huaweivsa/"
           data-tag="华为"
           data-author="" >
            <span class="post-title" title="属于华为的荣耀时刻">属于华为的荣耀时刻</span>
            <span class="post-date" title="2019-05-20 18:28:25">2019/05/20</span>
        </a>
        
        <a  class="全部文章 Openstack_op "
           href="/2019/04/19/sriov2ovs/"
           data-tag="sriov,ovs,脚本"
           data-author="" >
            <span class="post-title" title="sriov计算节点转ovs计算节点脚本">sriov计算节点转ovs计算节点脚本</span>
            <span class="post-date" title="2019-04-19 16:50:16">2019/04/19</span>
        </a>
        
        <a  class="全部文章 Openstack_op "
           href="/2019/04/18/placement/"
           data-tag="placement"
           data-author="" >
            <span class="post-title" title="Openstack Placement">Openstack Placement</span>
            <span class="post-date" title="2019-04-18 09:14:54">2019/04/18</span>
        </a>
        
        <a  class="全部文章 Openstack_op "
           href="/2018/10/21/power/"
           data-tag="POWER"
           data-author="" >
            <span class="post-title" title="POWER架构服务器作为计算节点">POWER架构服务器作为计算节点</span>
            <span class="post-date" title="2018-10-21 16:21:52">2018/10/21</span>
        </a>
        
        <a  class="全部文章 Openstack_op "
           href="/2018/10/14/sriov/"
           data-tag="SR-IOV,passthrough"
           data-author="" >
            <span class="post-title" title="OpenStack实践SR-IOV计算节点">OpenStack实践SR-IOV计算节点</span>
            <span class="post-date" title="2018-10-14 05:15:24">2018/10/14</span>
        </a>
        
        <a  class="全部文章 Openstack_op "
           href="/2018/09/29/openstackopmemo3/"
           data-tag="Openstack,devops"
           data-author="" >
            <span class="post-title" title="Openstack运维常见问题记录(3)">Openstack运维常见问题记录(3)</span>
            <span class="post-date" title="2018-09-29 20:28:32">2018/09/29</span>
        </a>
        
        <a  class="全部文章 基础篇 "
           href="/2018/09/05/ceph/"
           data-tag="vdbench"
           data-author="" >
            <span class="post-title" title="ceph数据存储的几个概念">ceph数据存储的几个概念</span>
            <span class="post-date" title="2018-09-05 17:32:47">2018/09/05</span>
        </a>
        
        <a  class="全部文章 Openstack_op "
           href="/2018/08/28/openstackopmemo2/"
           data-tag="Openstack,devops"
           data-author="" >
            <span class="post-title" title="Openstack运维常见问题记录(2)">Openstack运维常见问题记录(2)</span>
            <span class="post-date" title="2018-08-28 14:48:42">2018/08/28</span>
        </a>
        
        <a  class="全部文章 Openstack_op "
           href="/2018/08/26/openstackopmemo/"
           data-tag="Openstack,devops"
           data-author="" >
            <span class="post-title" title="Openstack运维常见问题记录(1)">Openstack运维常见问题记录(1)</span>
            <span class="post-date" title="2018-08-26 18:38:42">2018/08/26</span>
        </a>
        
        <a  class="全部文章 Openstack_op "
           href="/2018/08/16/2concepts/"
           data-tag="aggregation,available zone,numa"
           data-author="" >
            <span class="post-title" title="Openstack两组容易混淆的概念">Openstack两组容易混淆的概念</span>
            <span class="post-date" title="2018-08-16 15:08:05">2018/08/16</span>
        </a>
        
        <a  class="全部文章 自动化 "
           href="/2018/07/14/serverwalker/"
           data-tag="Serverwalker,自动化测试,DSL"
           data-author="" >
            <span class="post-title" title="自动化测试工具Serverwalker介绍">自动化测试工具Serverwalker介绍</span>
            <span class="post-date" title="2018-07-14 11:52:51">2018/07/14</span>
        </a>
        
        <a  class="全部文章 Openstack_dev "
           href="/2018/07/13/cpupin/"
           data-tag="cpu绑定"
           data-author="" >
            <span class="post-title" title="Openstack中的虚拟机的cpu绑定">Openstack中的虚拟机的cpu绑定</span>
            <span class="post-date" title="2018-07-13 20:09:41">2018/07/13</span>
        </a>
        
        <a  class="全部文章 业界 "
           href="/2018/05/10/huawei/"
           data-tag="华为,运营商"
           data-author="" >
            <span class="post-title" title="华为的发展已越来越不需要运营商">华为的发展已越来越不需要运营商</span>
            <span class="post-date" title="2018-05-10 23:45:05">2018/05/10</span>
        </a>
        
        <a  class="全部文章 Openstack_op "
           href="/2018/04/14/pike-novnc/"
           data-tag="Pike,noVNC"
           data-author="" >
            <span class="post-title" title="OpenStack Pike dashboard noVNC 不能访问">OpenStack Pike dashboard noVNC 不能访问</span>
            <span class="post-date" title="2018-04-14 05:18:22">2018/04/14</span>
        </a>
        
        <a  class="全部文章 Tools "
           href="/2018/04/14/pycharm2018/"
           data-tag="PyCharm"
           data-author="" >
            <span class="post-title" title="JetBrains PyCharm 2018.1.1 x64专业版永久激活">JetBrains PyCharm 2018.1.1 x64专业版永久激活</span>
            <span class="post-date" title="2018-04-14 04:47:29">2018/04/14</span>
        </a>
        
        <a  class="全部文章 Openstack_op "
           href="/2018/04/14/vmsystemddel/"
           data-tag="selinux,qemu,systemd"
           data-author="" >
            <span class="post-title" title="vm被systemd删除">vm被systemd删除</span>
            <span class="post-date" title="2018-04-14 04:30:35">2018/04/14</span>
        </a>
        
        <a  class="全部文章 Openstack_op "
           href="/2018/04/14/vmcantstart/"
           data-tag="selinux"
           data-author="" >
            <span class="post-title" title="虚拟机无法启动">虚拟机无法启动</span>
            <span class="post-date" title="2018-04-14 03:15:39">2018/04/14</span>
        </a>
        
        <a  class="全部文章 NFV "
           href="/2018/01/23/rt-vm/"
           data-tag="RT"
           data-author="" >
            <span class="post-title" title="部署实时OpenStack实例">部署实时OpenStack实例</span>
            <span class="post-date" title="2018-01-23 16:28:28">2018/01/23</span>
        </a>
        
        <a  class="全部文章 Openstack_op "
           href="/2018/01/23/scheduler-win-linux/"
           data-tag="nova-scheduler"
           data-author="" >
            <span class="post-title" title="支持windows虚拟机和linux虚拟机分区调度">支持windows虚拟机和linux虚拟机分区调度</span>
            <span class="post-date" title="2018-01-23 14:40:11">2018/01/23</span>
        </a>
        
        <a  class="全部文章 Openstack_op "
           href="/2017/12/28/local-yum/"
           data-tag="yum"
           data-author="" >
            <span class="post-title" title="Openstack Pike本地yum源搭建">Openstack Pike本地yum源搭建</span>
            <span class="post-date" title="2017-12-28 22:20:40">2017/12/28</span>
        </a>
        
        <a  class="全部文章 Openstack_op "
           href="/2017/12/28/p7-4-shell/"
           data-tag="Openstack Pike,安装"
           data-author="" >
            <span class="post-title" title="脚本安装Openstack Pike">脚本安装Openstack Pike</span>
            <span class="post-date" title="2017-12-28 20:43:27">2017/12/28</span>
        </a>
        
        <a  class="全部文章 NFV "
           href="/2017/12/08/kata-containers/"
           data-tag="Kata Containers,Intel Clear Container,Serverless"
           data-author="" >
            <span class="post-title" title="Kata Containers">Kata Containers</span>
            <span class="post-date" title="2017-12-08 00:27:10">2017/12/08</span>
        </a>
        
        <a  class="全部文章 NFV "
           href="/2017/11/12/raft-gossip/"
           data-tag="Raft,Gossip"
           data-author="" >
            <span class="post-title" title="Raft算法和Gossip协议">Raft算法和Gossip协议</span>
            <span class="post-date" title="2017-11-12 12:34:11">2017/11/12</span>
        </a>
        
        <a  class="全部文章 Openstack_op "
           href="/2017/11/10/vitrage/"
           data-tag="Vitrage"
           data-author="" >
            <span class="post-title" title="Openstack Vitrage（根因分析）">Openstack Vitrage（根因分析）</span>
            <span class="post-date" title="2017-11-10 08:02:15">2017/11/10</span>
        </a>
        
        <a  class="全部文章 NFV "
           href="/2017/11/08/RTOS/"
           data-tag="RT"
           data-author="" >
            <span class="post-title" title="实时操作系统">实时操作系统</span>
            <span class="post-date" title="2017-11-08 15:13:56">2017/11/08</span>
        </a>
        
        <a  class="全部文章 基础篇 "
           href="/2017/08/01/raid/"
           data-tag="RAID"
           data-author="" >
            <span class="post-title" title="RAID">RAID</span>
            <span class="post-date" title="2017-08-01 08:42:40">2017/08/01</span>
        </a>
        
        <a  class="全部文章 Openstack_op "
           href="/2017/07/31/vm-cpu/"
           data-tag="Nova,CPU"
           data-author="" >
            <span class="post-title" title="云主机的指令集配置">云主机的指令集配置</span>
            <span class="post-date" title="2017-07-31 05:05:20">2017/07/31</span>
        </a>
        
        <a  class="全部文章 业界 "
           href="/2017/07/20/yunyingshang-kongjian/"
           data-tag="运营商"
           data-author="" >
            <span class="post-title" title="AI大环境下的运营商">AI大环境下的运营商</span>
            <span class="post-date" title="2017-07-20 18:51:01">2017/07/20</span>
        </a>
        
        <a  class="全部文章 NFV "
           href="/2017/07/20/cpu-pinning/"
           data-tag="cpu-pinning"
           data-author="" >
            <span class="post-title" title="cpu-pinning CPU绑定">cpu-pinning CPU绑定</span>
            <span class="post-date" title="2017-07-20 18:30:18">2017/07/20</span>
        </a>
        
        <a  class="全部文章 NFV "
           href="/2017/07/20/numa/"
           data-tag="NUMA"
           data-author="" >
            <span class="post-title" title="NUMA 非一致性内存访问">NUMA 非一致性内存访问</span>
            <span class="post-date" title="2017-07-20 17:47:16">2017/07/20</span>
        </a>
        
        <a  class="全部文章 NFV "
           href="/2017/07/19/vmem/"
           data-tag="KSM,Huge Page"
           data-author="" >
            <span class="post-title" title="内存虚拟化">内存虚拟化</span>
            <span class="post-date" title="2017-07-19 05:17:46">2017/07/19</span>
        </a>
        
        <a  class="全部文章 Openstack_op "
           href="/2017/07/04/resize-error/"
           data-tag="Nova"
           data-author="" >
            <span class="post-title" title="resize失败原因调查">resize失败原因调查</span>
            <span class="post-date" title="2017-07-04 10:20:06">2017/07/04</span>
        </a>
        
        <a  class="全部文章 Openstack_op "
           href="/2017/06/30/attach-yunyingpan/"
           data-tag="云硬盘"
           data-author="" >
            <span class="post-title" title="挂载云硬盘">挂载云硬盘</span>
            <span class="post-date" title="2017-06-30 05:16:38">2017/06/30</span>
        </a>
        
        <a  class="全部文章 Openstack_dev "
           href="/2017/06/28/ocata-nova-evacuate-bug/"
           data-tag="Nova,Ocata,Bug"
           data-author="" >
            <span class="post-title" title="Ocata nova evacuate bug">Ocata nova evacuate bug</span>
            <span class="post-date" title="2017-06-28 18:24:18">2017/06/28</span>
        </a>
        
        <a  class="全部文章 敏捷 "
           href="/2017/06/28/trigger-build/"
           data-tag="gerrit,jenkins,持续集成"
           data-author="" >
            <span class="post-title" title="gerrit触发jenkins执行脚本自动构建rpm包">gerrit触发jenkins执行脚本自动构建rpm包</span>
            <span class="post-date" title="2017-06-28 18:17:13">2017/06/28</span>
        </a>
        
        <a  class="全部文章 敏捷 "
           href="/2017/06/28/gerrit-install/"
           data-tag="gerrit"
           data-author="" >
            <span class="post-title" title="gerrit install">gerrit install</span>
            <span class="post-date" title="2017-06-28 15:51:07">2017/06/28</span>
        </a>
        
        <a  class="全部文章 敏捷 "
           href="/2017/06/27/jira-install/"
           data-tag="JIRA"
           data-author="" >
            <span class="post-title" title="JIRA安装">JIRA安装</span>
            <span class="post-date" title="2017-06-27 01:53:54">2017/06/27</span>
        </a>
        
        <a  class="全部文章 "
           href="/2017/06/22/compute-node-ha/"
           data-tag="HA,masakari"
           data-author="" >
            <span class="post-title" title="compute node ha 主流开源实现">compute node ha 主流开源实现</span>
            <span class="post-date" title="2017-06-22 09:16:48">2017/06/22</span>
        </a>
        
        <a  class="全部文章 Openstack_op "
           href="/2017/06/15/live-migration-fail/"
           data-tag="热迁移"
           data-author="" >
            <span class="post-title" title="热迁移失败总结">热迁移失败总结</span>
            <span class="post-date" title="2017-06-15 18:54:53">2017/06/15</span>
        </a>
        
        <a  class="全部文章 Collectd "
           href="/2017/06/15/collectd-influxdb/"
           data-tag="Collectd,InfluxDB"
           data-author="" >
            <span class="post-title" title="Collectd 和 InfluxDB 的部署和使用">Collectd 和 InfluxDB 的部署和使用</span>
            <span class="post-date" title="2017-06-15 06:47:53">2017/06/15</span>
        </a>
        
        <a  class="全部文章 Openstack_op "
           href="/2017/06/14/block-migrate/"
           data-tag="Nova,热迁移"
           data-author="" >
            <span class="post-title" title="本地存储条件下的热迁移">本地存储条件下的热迁移</span>
            <span class="post-date" title="2017-06-14 15:25:48">2017/06/14</span>
        </a>
        
        <a  class="全部文章 NFV "
           href="/2017/06/14/doctor/"
           data-tag="Doctor"
           data-author="" >
            <span class="post-title" title="Doctor framework">Doctor framework</span>
            <span class="post-date" title="2017-06-14 11:51:04">2017/06/14</span>
        </a>
        
        <a  class="全部文章 Openstack_dev "
           href="/2017/06/10/add-quick-evacuate/"
           data-tag="VM HA,Nova"
           data-author="" >
            <span class="post-title" title="将快速疏散功能加入VM HA程序中">将快速疏散功能加入VM HA程序中</span>
            <span class="post-date" title="2017-06-10 03:27:36">2017/06/10</span>
        </a>
        
        <a  class="全部文章 Openstack_dev "
           href="/2017/06/08/force-down/"
           data-tag="Nova,evacuate"
           data-author="" >
            <span class="post-title" title="新增OpenStack NOVA API用于强制计算节点nova-compute服务down">新增OpenStack NOVA API用于强制计算节点nova-compute服务down</span>
            <span class="post-date" title="2017-06-08 20:11:17">2017/06/08</span>
        </a>
        
        <a  class="全部文章 Openstack_op "
           href="/2017/06/07/storage-arch/"
           data-tag="存储"
           data-author="" >
            <span class="post-title" title="vm挂载卷，镜像，vm实例的共享存储架构">vm挂载卷，镜像，vm实例的共享存储架构</span>
            <span class="post-date" title="2017-06-07 08:20:29">2017/06/07</span>
        </a>
        
        <a  class="全部文章 动态 "
           href="/2017/05/06/https/"
           data-tag="https"
           data-author="" >
            <span class="post-title" title="后端云站全部采用https连接">后端云站全部采用https连接</span>
            <span class="post-date" title="2017-05-06 11:03:57">2017/05/06</span>
        </a>
        
        <a  class="全部文章 Openstack_op "
           href="/2017/05/04/win-register/"
           data-tag="windows"
           data-author="" >
            <span class="post-title" title="windows虚拟机激活失败问题">windows虚拟机激活失败问题</span>
            <span class="post-date" title="2017-05-04 22:21:24">2017/05/04</span>
        </a>
        
        <a  class="全部文章 自动化 "
           href="/2017/05/03/ansible/"
           data-tag="ansible"
           data-author="" >
            <span class="post-title" title="ansible简单使用">ansible简单使用</span>
            <span class="post-date" title="2017-05-03 07:55:42">2017/05/03</span>
        </a>
        
        <a  class="全部文章 智能云 "
           href="/2017/05/02/pci-api/"
           data-tag="PCI,API"
           data-author="" >
            <span class="post-title" title="pci-api support">pci-api support</span>
            <span class="post-date" title="2017-05-02 10:11:54">2017/05/02</span>
        </a>
        
        <a  class="全部文章 智能云 "
           href="/2017/05/01/cyborg-agent/"
           data-tag="Cyborg"
           data-author="" >
            <span class="post-title" title="cyborg agent">cyborg agent</span>
            <span class="post-date" title="2017-05-01 17:49:47">2017/05/01</span>
        </a>
        
        <a  class="全部文章 Openstack_op "
           href="/2017/05/01/vm-mem/"
           data-tag="内存"
           data-author="" >
            <span class="post-title" title="获取虚机内存">获取虚机内存</span>
            <span class="post-date" title="2017-05-01 14:27:38">2017/05/01</span>
        </a>
        
        <a  class="全部文章 智能云 "
           href="/2017/05/01/fpag-user-case/"
           data-tag="FPGA"
           data-author="" >
            <span class="post-title" title="FPGA用户用例提案">FPGA用户用例提案</span>
            <span class="post-date" title="2017-05-01 13:39:58">2017/05/01</span>
        </a>
        
        <a  class="全部文章 智能云 "
           href="/2017/04/29/gpu-config-rst/"
           data-tag="GPU,配置"
           data-author="" >
            <span class="post-title" title="云环境中GPU配置">云环境中GPU配置</span>
            <span class="post-date" title="2017-04-29 18:49:59">2017/04/29</span>
        </a>
        
        <a  class="全部文章 业界 "
           href="/2017/03/10/yunying-huawei/"
           data-tag="华为,运营商"
           data-author="" >
            <span class="post-title" title="华为和运营商们">华为和运营商们</span>
            <span class="post-date" title="2017-03-10 21:25:44">2017/03/10</span>
        </a>
        
        <a  class="全部文章 Tools "
           href="/2017/03/07/hosts-google/"
           data-tag="google,hosts"
           data-author="" >
            <span class="post-title" title="访问google">访问google</span>
            <span class="post-date" title="2017-03-07 01:14:05">2017/03/07</span>
        </a>
        
        <a  class="全部文章 Openstack_op "
           href="/2017/02/24/ocata-packstack/"
           data-tag="Openstack Ocata"
           data-author="" >
            <span class="post-title" title="Openstack Ocata初体验">Openstack Ocata初体验</span>
            <span class="post-date" title="2017-02-24 16:45:50">2017/02/24</span>
        </a>
        
        <a  class="全部文章 Tools "
           href="/2017/02/17/qq-ad/"
           data-tag="QQ,广告"
           data-author="" >
            <span class="post-title" title="去QQ广告">去QQ广告</span>
            <span class="post-date" title="2017-02-17 03:41:34">2017/02/17</span>
        </a>
        
        <a  class="全部文章 Openstack_op "
           href="/2017/02/08/glance-regiontwo2one/"
           data-tag="Region"
           data-author="" >
            <span class="post-title" title="openstack两个region分别用各自glance服务-&gt;共用glance服务">openstack两个region分别用各自glance服务-&gt;共用glance服务</span>
            <span class="post-date" title="2017-02-08 16:51:34">2017/02/08</span>
        </a>
        
        <a  class="全部文章 Python "
           href="/2017/01/17/zh-google-python-styleguide/"
           data-tag="Python"
           data-author="" >
            <span class="post-title" title="google Python 风格指南（中文版）">google Python 风格指南（中文版）</span>
            <span class="post-date" title="2017-01-17 18:03:22">2017/01/17</span>
        </a>
        
        <a  class="全部文章 智能云 "
           href="/2017/01/07/cyborg_intro/"
           data-tag="Cyborg,Openstack"
           data-author="" >
            <span class="post-title" title="Openstack Cyborg 项目介绍">Openstack Cyborg 项目介绍</span>
            <span class="post-date" title="2017-01-07 00:38:19">2017/01/07</span>
        </a>
        
        <a  class="全部文章 Tools "
           href="/2016/12/24/xshell-skill/"
           data-tag="xshell,隧道,效率,转发,多级跳转"
           data-author="" >
            <span class="post-title" title="xshell工具在开发中的使用技巧">xshell工具在开发中的使用技巧</span>
            <span class="post-date" title="2016-12-24 23:10:36">2016/12/24</span>
        </a>
        
        <a  class="全部文章 Tools "
           href="/2016/09/02/vim-python/"
           data-tag="vim"
           data-author="" >
            <span class="post-title" title="python，NFV项目开发--vim">python，NFV项目开发--vim</span>
            <span class="post-date" title="2016-09-02 19:35:02">2016/09/02</span>
        </a>
        
        <a  class="全部文章 Openstack_op "
           href="/2016/08/18/vncviewer-openstack-vm/"
           data-tag="vnc"
           data-author="" >
            <span class="post-title" title="网络不通的情况下，不通过dashboard，在未装图形化系统上查看openstack 创建的vm">网络不通的情况下，不通过dashboard，在未装图形化系统上查看openstack 创建的vm</span>
            <span class="post-date" title="2016-08-18 13:49:11">2016/08/18</span>
        </a>
        
        <a  class="全部文章 Openstack_op "
           href="/2016/07/05/lb/"
           data-tag="Load Balance,LVS"
           data-author="" >
            <span class="post-title" title="Load Balance(LVS实现方式)">Load Balance(LVS实现方式)</span>
            <span class="post-date" title="2016-07-05 23:10:25">2016/07/05</span>
        </a>
        
        <a  class="全部文章 NFV "
           href="/2016/07/05/vnfd-template-para/"
           data-tag="VNFD,template,parameter"
           data-author="" >
            <span class="post-title" title="VNFD模板参数化">VNFD模板参数化</span>
            <span class="post-date" title="2016-07-05 22:57:33">2016/07/05</span>
        </a>
        
        <a  class="全部文章 NFV "
           href="/2016/06/11/prediction/"
           data-tag="OPNFV Prediction"
           data-author="" >
            <span class="post-title" title="OPNFV Prediction">OPNFV Prediction</span>
            <span class="post-date" title="2016-06-11 16:11:10">2016/06/11</span>
        </a>
        
        <a  class="全部文章 Openstack_dev "
           href="/2016/06/11/token-manage/"
           data-tag="openstack token管理"
           data-author="" >
            <span class="post-title" title="openstack token管理">openstack token管理</span>
            <span class="post-date" title="2016-06-11 15:23:00">2016/06/11</span>
        </a>
        
        <a  class="全部文章 NFV "
           href="/2015/12/20/project-life-cycle/"
           data-tag="生命周期,提案,孵化,成熟,集成,归档"
           data-author="" >
            <span class="post-title" title="OPNFV项目生命周期">OPNFV项目生命周期</span>
            <span class="post-date" title="2015-12-20 20:02:27">2015/12/20</span>
        </a>
        
        <a  class="全部文章 NFV "
           href="/2015/12/20/system_membership/"
           data-tag="管理体制,会员制,会员,Board,TSC"
           data-author="" >
            <span class="post-title" title="OPNFV的管理体制和会员制">OPNFV的管理体制和会员制</span>
            <span class="post-date" title="2015-12-20 19:32:42">2015/12/20</span>
        </a>
        
        <a  class="全部文章 NFV "
           href="/2015/12/19/introduction-4/"
           data-tag="开发,开源,参与"
           data-author="" >
            <span class="post-title" title="OPNFV简介(4) - 对所有人开放">OPNFV简介(4) - 对所有人开放</span>
            <span class="post-date" title="2015-12-19 16:16:06">2015/12/19</span>
        </a>
        
        <a  class="全部文章 NFV "
           href="/2015/12/19/introduction-3/"
           data-tag="上游关系"
           data-author="" >
            <span class="post-title" title="OPNFV简介(3) - 和上游关系">OPNFV简介(3) - 和上游关系</span>
            <span class="post-date" title="2015-12-19 16:04:59">2015/12/19</span>
        </a>
        
        <a  class="全部文章 NFV "
           href="/2015/12/19/introduction-2/"
           data-tag="子项目,ETSI,目标,生态"
           data-author="" >
            <span class="post-title" title="OPNFV简介(2) - overview">OPNFV简介(2) - overview</span>
            <span class="post-date" title="2015-12-19 15:54:34">2015/12/19</span>
        </a>
        
        <a  class="全部文章 NFV "
           href="/2015/12/18/introduction-1/"
           data-tag="产业趋势,产业需求"
           data-author="" >
            <span class="post-title" title="OPNFV简介(1) - 背景">OPNFV简介(1) - 背景</span>
            <span class="post-date" title="2015-12-18 00:44:16">2015/12/18</span>
        </a>
        
        <div id="no-item-tips">

        </div>
    </nav>
    <div id="outline-list">
    </div>
</div>
    </div>
    <div class="hide-list">
        <div class="semicircle" data-title="切换全屏 快捷键 s">
            <div class="brackets first"><</div>
            <div class="brackets">&gt;</div>
        </div>
    </div>
</aside>
<div id="post">
    <div class="pjax">
        <article id="post-masakari-task-code" class="article article-type-post" itemscope itemprop="blogPost">
    
        <h1 class="article-title">Openstack Masakari task流程源码分析</h1>
    
    <div class="article-meta">
        
        
        
        <span class="book">
            <i class="iconfont icon-category"></i>
            
            
            <a  data-rel="Openstack_dev">Openstack_dev</a>
            
        </span>
        
        
        <span class="tag">
            <i class="iconfont icon-tag"></i>
            
            <a class="color1">VM HA</a>
            
            <a class="color5">Openstack</a>
            
            <a class="color4">Masakari</a>
            
            <a class="color5">源码分析</a>
            
        </span>
        
    </div>
    <div class="article-meta">
        
            发布时间 : <time class="date" title='最后更新: 2022-04-02 08:42:52'>2020-01-09 09:18</time>
        
    </div>
    <div class="article-meta">
        
        
        <span id="busuanzi_container_page_pv">
            阅读 :<span id="busuanzi_value_page_pv">
                <span class="count-comment">
                    <span class="spinner">
                      <div class="cube1"></div>
                      <div class="cube2"></div>
                    </span>
                </span>
            </span>
        </span>
        
        
    </div>
    
    <div class="toc-ref">
    
        <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%BF%9B%E7%A8%8B%E6%95%85%E9%9A%9C%E5%A4%84%E7%90%86%E6%B5%81%E7%A8%8B"><span class="toc-text">进程故障处理流程</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%99%9A%E6%8B%9F%E6%9C%BA%E5%AE%9E%E4%BE%8B%E6%95%85%E9%9A%9C%E5%A4%84%E7%90%86%E6%B5%81%E7%A8%8B"><span class="toc-text">虚拟机实例故障处理流程</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%8A%82%E7%82%B9%E6%95%85%E9%9A%9C%E5%A4%84%E7%90%86%E6%B5%81%E7%A8%8B"><span class="toc-text">节点故障处理流程</span></a></li></ol>
    
<style>
    .left-col .switch-btn,
    .left-col .switch-area {
        display: none;
    }
    .toc-level-3 i,
    .toc-level-3 ol {
        display: none !important;
    }
</style>
</div>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p><code>目录：</code>（可以按<code>w</code>快捷键切换大纲视图）<br><div class='inner-toc'><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%BF%9B%E7%A8%8B%E6%95%85%E9%9A%9C%E5%A4%84%E7%90%86%E6%B5%81%E7%A8%8B"><span class="toc-text">进程故障处理流程</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%99%9A%E6%8B%9F%E6%9C%BA%E5%AE%9E%E4%BE%8B%E6%95%85%E9%9A%9C%E5%A4%84%E7%90%86%E6%B5%81%E7%A8%8B"><span class="toc-text">虚拟机实例故障处理流程</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%8A%82%E7%82%B9%E6%95%85%E9%9A%9C%E5%A4%84%E7%90%86%E6%B5%81%E7%A8%8B"><span class="toc-text">节点故障处理流程</span></a></li></ol></div></p>
<p>Masakari一词来源于日语板斧，该项目是Openstack社区的一个用来实现VM HA的开源项目。目前masakari支持下面3种故障恢复：</p>
<ol>
<li>provisioning process down</li>
<li>VM process down</li>
<li>nova-compute host failure</li>
</ol>
<p>本文将对以上三种故障处理流程的代码做详细分析。</p>
<p><strong>masakari架构图：</strong><br><img src="/images/masakari-task-code/1.svg" alt="pic"></p>
<h1 id="进程故障处理流程"><a href="#进程故障处理流程" class="headerlink" title="进程故障处理流程"></a>进程故障处理流程</h1><p>所谓的进程就是计算节点的关键进程和服务，如<code>libvirt</code>, <code>nova-compute</code>, <code>masakari-instancemonitor</code>, <code>masakari-hostmonitor</code>, <code>sshd</code>, 一旦检测到进程异常，执行下面的流程。<br>该流程分为2步<br>第一步，disable计算节点的nova服务，让新创建的vm不会被调度到该节点。<br>第二步，监测第一步的disable动作是否被有效执行</p>
<p><code>masakari\engine\drivers\taskflow\process_failure.py</code></p>
<pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">DisableComputeNodeTask</span><span class="token punctuation">(</span>base<span class="token punctuation">.</span>MasakariTask<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> context<span class="token punctuation">,</span> novaclient<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>
        kwargs<span class="token punctuation">[</span><span class="token string">'requires'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">"process_name"</span><span class="token punctuation">,</span> <span class="token string">"host_name"</span><span class="token punctuation">]</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>DisableComputeNodeTask<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span>context<span class="token punctuation">,</span>
                                                     novaclient<span class="token punctuation">,</span>
                                                     <span class="token operator">**</span>kwargs<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">execute</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> process_name<span class="token punctuation">,</span> host_name<span class="token punctuation">)</span><span class="token punctuation">:</span>
        msg <span class="token operator">=</span> <span class="token string">"Disabling compute service on host: '%s'"</span> <span class="token operator">%</span> host_name
        self<span class="token punctuation">.</span>update_details<span class="token punctuation">(</span>msg<span class="token punctuation">)</span>

        <span class="token keyword">if</span> <span class="token keyword">not</span> self<span class="token punctuation">.</span>novaclient<span class="token punctuation">.</span>is_service_down<span class="token punctuation">(</span>self<span class="token punctuation">.</span>context<span class="token punctuation">,</span> host_name<span class="token punctuation">,</span>
                                               process_name<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token comment"># disable compute node on given host</span>
            self<span class="token punctuation">.</span>novaclient<span class="token punctuation">.</span>enable_disable_service<span class="token punctuation">(</span>self<span class="token punctuation">.</span>context<span class="token punctuation">,</span> host_name<span class="token punctuation">)</span>
            msg <span class="token operator">=</span> <span class="token string">"Disabled compute service on host: '%s'"</span> <span class="token operator">%</span> host_name
            self<span class="token punctuation">.</span>update_details<span class="token punctuation">(</span>msg<span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            msg <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token string">"Skipping recovery for process %(process_name)s as it is "</span>
                   <span class="token string">"already disabled"</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token punctuation">&#123;</span><span class="token string">'process_name'</span><span class="token punctuation">:</span> process_name<span class="token punctuation">&#125;</span>
            LOG<span class="token punctuation">.</span>info<span class="token punctuation">(</span>msg<span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>update_details<span class="token punctuation">(</span>msg<span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span></code></pre>

<p>给出<code>Disabling compute service on host &lt;hostname&gt;</code>消息后，判断host的计算服务是否down了，若没有执行<code>enable_disable_service</code>方法，执行完成该<code>diasble</code>动作后，给出<code>Disabled compute service on host &lt;hostname&gt;</code>消息；若已经down了，只给出<code>Skipping recovery for process %(process_name)s as it is already disabled</code>。</p>
<p>上面的DisableComputeNodeTask流程用了2个调用nova的方法<code>is_service_down</code>和<code>enable_disable_service</code>。</p>
<a id="more"></a>


<p><code>masakari\compute\nova.py</code></p>
<pre class="language-python" data-language="python"><code class="language-python"><span class="token decorator annotation punctuation">@translate_nova_exception</span>
<span class="token keyword">def</span> <span class="token function">is_service_down</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> context<span class="token punctuation">,</span> host_name<span class="token punctuation">,</span> binary<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""Check whether service is up or down on given host."""</span>
    nova <span class="token operator">=</span> novaclient<span class="token punctuation">(</span>context<span class="token punctuation">)</span>
    service <span class="token operator">=</span> nova<span class="token punctuation">.</span>services<span class="token punctuation">.</span><span class="token builtin">list</span><span class="token punctuation">(</span>host<span class="token operator">=</span>host_name<span class="token punctuation">,</span> binary<span class="token operator">=</span>binary<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    <span class="token keyword">return</span> service<span class="token punctuation">.</span>status <span class="token operator">==</span> <span class="token string">'disabled'</span></code></pre>
<p>方法<code>is_service_down</code>调用novaclient模块的<code>services.list</code>查询该<code>host_name</code>的<code>service</code>信息，返回<code>service.status</code>是否为<code>disabled</code>。</p>
<p><code>masakari\compute\nova.py</code></p>
<pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">enable_disable_service</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> context<span class="token punctuation">,</span> host_name<span class="token punctuation">,</span> enable<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>
                           reason<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""Enable or disable the service specified by nova service id."""</span>
    nova <span class="token operator">=</span> novaclient<span class="token punctuation">(</span>context<span class="token punctuation">)</span>
    service <span class="token operator">=</span> nova<span class="token punctuation">.</span>services<span class="token punctuation">.</span><span class="token builtin">list</span><span class="token punctuation">(</span>host<span class="token operator">=</span>host_name<span class="token punctuation">,</span> binary<span class="token operator">=</span><span class="token string">'nova-compute'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>

    <span class="token keyword">if</span> <span class="token keyword">not</span> enable<span class="token punctuation">:</span>
        LOG<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">'Disable nova-compute on %s'</span><span class="token punctuation">,</span> host_name<span class="token punctuation">)</span>
        <span class="token keyword">if</span> reason<span class="token punctuation">:</span>
            nova<span class="token punctuation">.</span>services<span class="token punctuation">.</span>disable_log_reason<span class="token punctuation">(</span>service<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">,</span> reason<span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            nova<span class="token punctuation">.</span>services<span class="token punctuation">.</span>disable<span class="token punctuation">(</span>service<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        LOG<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">'Enable nova-compute on %s'</span><span class="token punctuation">,</span> host_name<span class="token punctuation">)</span>
        nova<span class="token punctuation">.</span>services<span class="token punctuation">.</span>enable<span class="token punctuation">(</span>service<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">)</span></code></pre>
<p>方法<code>enable_disable_service</code>调用novaclient模块的<code>services.list</code>查询该<code>host_name</code>的<code>service</code>信息，若<code>service.status</code>是<code>enable</code>则调用novaclient模块的<code>services.disable</code>disable服务（若有disable的原因，则加上reason参数）；若是<code>disable</code>则调用novaclient模块的<code>services.enable</code>enable服务。</p>
<p><code>masakari\engine\drivers\taskflow\process_failure.py</code></p>
<pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">ConfirmComputeNodeDisabledTask</span><span class="token punctuation">(</span>base<span class="token punctuation">.</span>MasakariTask<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> context<span class="token punctuation">,</span> novaclient<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>
        kwargs<span class="token punctuation">[</span><span class="token string">'requires'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">"process_name"</span><span class="token punctuation">,</span> <span class="token string">"host_name"</span><span class="token punctuation">]</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>ConfirmComputeNodeDisabledTask<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span>context<span class="token punctuation">,</span>
                                                             novaclient<span class="token punctuation">,</span>
                                                             <span class="token operator">**</span>kwargs<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">execute</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> process_name<span class="token punctuation">,</span> host_name<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">def</span> <span class="token function">_wait_for_disable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            service_disabled <span class="token operator">=</span> self<span class="token punctuation">.</span>novaclient<span class="token punctuation">.</span>is_service_down<span class="token punctuation">(</span>
                self<span class="token punctuation">.</span>context<span class="token punctuation">,</span> host_name<span class="token punctuation">,</span> process_name<span class="token punctuation">)</span>
            <span class="token keyword">if</span> service_disabled<span class="token punctuation">:</span>
                <span class="token keyword">raise</span> loopingcall<span class="token punctuation">.</span>LoopingCallDone<span class="token punctuation">(</span><span class="token punctuation">)</span>

        periodic_call <span class="token operator">=</span> loopingcall<span class="token punctuation">.</span>FixedIntervalLoopingCall<span class="token punctuation">(</span>
            _wait_for_disable<span class="token punctuation">)</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            msg <span class="token operator">=</span> <span class="token string">"Confirming compute service is disabled on host: '%s'"</span> <span class="token operator">%</span> <span class="token punctuation">(</span>
                host_name<span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>update_details<span class="token punctuation">(</span>msg<span class="token punctuation">)</span>

            <span class="token comment"># add a timeout to the periodic call.</span>
            periodic_call<span class="token punctuation">.</span>start<span class="token punctuation">(</span>interval<span class="token operator">=</span>CONF<span class="token punctuation">.</span>verify_interval<span class="token punctuation">)</span>
            etimeout<span class="token punctuation">.</span>with_timeout<span class="token punctuation">(</span>
                CONF<span class="token punctuation">.</span>wait_period_after_service_update<span class="token punctuation">,</span>
                periodic_call<span class="token punctuation">.</span>wait<span class="token punctuation">)</span>

            msg <span class="token operator">=</span> <span class="token string">"Confirmed compute service is disabled on host: '%s'"</span> <span class="token operator">%</span> <span class="token punctuation">(</span>
                host_name<span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>update_details<span class="token punctuation">(</span>msg<span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span>
        <span class="token keyword">except</span> etimeout<span class="token punctuation">.</span>Timeout<span class="token punctuation">:</span>
            msg <span class="token operator">=</span> <span class="token string">"Failed to disable service %(process_name)s"</span> <span class="token operator">%</span> <span class="token punctuation">&#123;</span>
                <span class="token string">'process_name'</span><span class="token punctuation">:</span> process_name
            <span class="token punctuation">&#125;</span>
            self<span class="token punctuation">.</span>update_details<span class="token punctuation">(</span>msg<span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span>
            <span class="token keyword">raise</span> exception<span class="token punctuation">.</span>ProcessRecoveryFailureException<span class="token punctuation">(</span>
                message<span class="token operator">=</span>msg<span class="token punctuation">)</span>
        <span class="token keyword">finally</span><span class="token punctuation">:</span>
            <span class="token comment"># stop the periodic call, in case of exceptions or Timeout.</span>
            periodic_call<span class="token punctuation">.</span>stop<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre>
<p>这段代码是一段监控动作的固定代码，做的事情就是调用Openstack的公共模块<code>oslo_service</code>，每隔一段时间去监测之前的<code>DisableComputeNodeTask</code>动作是否完成，是否超时。下面的几个其他流程的监控代码类似。</p>
<p><code>masakari/setup.cfg</code>文件对task名称的定义：</p>
<pre><code>masakari.task_flow.tasks =
    disable_compute_service_task = masakari.engine.drivers.taskflow.host_failure:DisableComputeServiceTask
    confirm_compute_node_disabled_task = masakari.engine.drivers.taskflow.process_failure:ConfirmComputeNodeDisabledTask</code></pre>
<p>配置文件对流程的定义：</p>
<pre><code>    cfg.Opt(&#39;process_failure_recovery_tasks&#39;,
            type=types.Dict(
                bounds=False,
                value_type=types.List(bounds=True,
                                      item_type=types.String(quotes=True))),
            default=&#123;&#39;pre&#39;: [&#39;disable_compute_node_task&#39;],
                     &#39;main&#39;: [&#39;confirm_compute_node_disabled_task&#39;],
                     &#39;post&#39;: []&#125;,
            help=(&quot;&quot;&quot;
This option allows operator to customize tasks to be executed for process
failure recovery workflow.

Provide list of strings reflecting to the task classes that should be included
to the process failure recovery workflow. The full classname path of all task
classes should be defined in the &#39;masakari.task_flow.tasks&#39; of setup.cfg and
these classes may be implemented by OpenStack Masaskari project team, deployer
or third party.

By default below two tasks will be part of this config option:-
1. disable_compute_node_task
2. confirm_compute_node_disabled_task

The allowed values for this option is comma separated dictionary of object
names in between ``&#123;`` and ``&#125;``.&quot;&quot;&quot;))
]</code></pre>
<h1 id="虚拟机实例故障处理流程"><a href="#虚拟机实例故障处理流程" class="headerlink" title="虚拟机实例故障处理流程"></a>虚拟机实例故障处理流程</h1><p><code>masakari\engine\drivers\taskflow\instance_failure.py</code></p>
<pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">StopInstanceTask</span><span class="token punctuation">(</span>base<span class="token punctuation">.</span>MasakariTask<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> context<span class="token punctuation">,</span> novaclient<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>
        kwargs<span class="token punctuation">[</span><span class="token string">'requires'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">"instance_uuid"</span><span class="token punctuation">]</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>StopInstanceTask<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span>context<span class="token punctuation">,</span>
                                               novaclient<span class="token punctuation">,</span>
                                               <span class="token operator">**</span>kwargs<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">execute</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> instance_uuid<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""Stop the instance for recovery."""</span>
        instance <span class="token operator">=</span> self<span class="token punctuation">.</span>novaclient<span class="token punctuation">.</span>get_server<span class="token punctuation">(</span>self<span class="token punctuation">.</span>context<span class="token punctuation">,</span> instance_uuid<span class="token punctuation">)</span>

        <span class="token comment"># If an instance is not HA_Enabled and "process_all_instances" config</span>
        <span class="token comment"># option is also disabled, then there is no need to take any recovery</span>
        <span class="token comment"># action.</span>
        <span class="token keyword">if</span> <span class="token keyword">not</span> CONF<span class="token punctuation">.</span>instance_failure<span class="token punctuation">.</span>process_all_instances <span class="token keyword">and</span> <span class="token keyword">not</span> <span class="token punctuation">(</span>
                strutils<span class="token punctuation">.</span>bool_from_string<span class="token punctuation">(</span>
                    instance<span class="token punctuation">.</span>metadata<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'HA_Enabled'</span><span class="token punctuation">,</span> <span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            msg <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token string">"Skipping recovery for instance: %(instance_uuid)s as it is"</span>
                   <span class="token string">" not Ha_Enabled"</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token punctuation">&#123;</span><span class="token string">'instance_uuid'</span><span class="token punctuation">:</span> instance_uuid<span class="token punctuation">&#125;</span>
            LOG<span class="token punctuation">.</span>info<span class="token punctuation">(</span>msg<span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>update_details<span class="token punctuation">(</span>msg<span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span>
            <span class="token keyword">raise</span> exception<span class="token punctuation">.</span>SkipInstanceRecoveryException<span class="token punctuation">(</span><span class="token punctuation">)</span>

        vm_state <span class="token operator">=</span> <span class="token builtin">getattr</span><span class="token punctuation">(</span>instance<span class="token punctuation">,</span> <span class="token string">'OS-EXT-STS:vm_state'</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> vm_state <span class="token keyword">in</span> <span class="token punctuation">[</span><span class="token string">'paused'</span><span class="token punctuation">,</span> <span class="token string">'rescued'</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
            msg <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token string">"Recovery of instance '%(instance_uuid)s' is ignored as it "</span>
                   <span class="token string">"is in '%(vm_state)s' state."</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token punctuation">&#123;</span>
                <span class="token string">'instance_uuid'</span><span class="token punctuation">:</span> instance_uuid<span class="token punctuation">,</span> <span class="token string">'vm_state'</span><span class="token punctuation">:</span> vm_state
            <span class="token punctuation">&#125;</span>
            LOG<span class="token punctuation">.</span>warning<span class="token punctuation">(</span>msg<span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>update_details<span class="token punctuation">(</span>msg<span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span>
            <span class="token keyword">raise</span> exception<span class="token punctuation">.</span>IgnoreInstanceRecoveryException<span class="token punctuation">(</span>msg<span class="token punctuation">)</span>

        <span class="token keyword">if</span> vm_state <span class="token operator">!=</span> <span class="token string">'stopped'</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span> vm_state <span class="token operator">==</span> <span class="token string">'resized'</span><span class="token punctuation">:</span>
                self<span class="token punctuation">.</span>novaclient<span class="token punctuation">.</span>reset_instance_state<span class="token punctuation">(</span>
                    self<span class="token punctuation">.</span>context<span class="token punctuation">,</span> instance<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">,</span> <span class="token string">'active'</span><span class="token punctuation">)</span>

            msg <span class="token operator">=</span> <span class="token string">"Stopping instance: %s"</span> <span class="token operator">%</span> instance_uuid
            self<span class="token punctuation">.</span>update_details<span class="token punctuation">(</span>msg<span class="token punctuation">)</span>

            self<span class="token punctuation">.</span>novaclient<span class="token punctuation">.</span>stop_server<span class="token punctuation">(</span>self<span class="token punctuation">.</span>context<span class="token punctuation">,</span> instance<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">)</span>

        <span class="token keyword">def</span> <span class="token function">_wait_for_power_off</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            new_instance <span class="token operator">=</span> self<span class="token punctuation">.</span>novaclient<span class="token punctuation">.</span>get_server<span class="token punctuation">(</span>self<span class="token punctuation">.</span>context<span class="token punctuation">,</span>
                                                      instance_uuid<span class="token punctuation">)</span>
            vm_state <span class="token operator">=</span> <span class="token builtin">getattr</span><span class="token punctuation">(</span>new_instance<span class="token punctuation">,</span> <span class="token string">'OS-EXT-STS:vm_state'</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> vm_state <span class="token operator">==</span> <span class="token string">'stopped'</span><span class="token punctuation">:</span>
                <span class="token keyword">raise</span> loopingcall<span class="token punctuation">.</span>LoopingCallDone<span class="token punctuation">(</span><span class="token punctuation">)</span>

        periodic_call <span class="token operator">=</span> loopingcall<span class="token punctuation">.</span>FixedIntervalLoopingCall<span class="token punctuation">(</span>
            _wait_for_power_off<span class="token punctuation">)</span>

        <span class="token keyword">try</span><span class="token punctuation">:</span>
            <span class="token comment"># add a timeout to the periodic call.</span>
            periodic_call<span class="token punctuation">.</span>start<span class="token punctuation">(</span>interval<span class="token operator">=</span>CONF<span class="token punctuation">.</span>verify_interval<span class="token punctuation">)</span>
            etimeout<span class="token punctuation">.</span>with_timeout<span class="token punctuation">(</span>CONF<span class="token punctuation">.</span>wait_period_after_power_off<span class="token punctuation">,</span>
                                  periodic_call<span class="token punctuation">.</span>wait<span class="token punctuation">)</span>
            msg <span class="token operator">=</span> <span class="token string">"Stopped instance: '%s'"</span> <span class="token operator">%</span> instance_uuid
            self<span class="token punctuation">.</span>update_details<span class="token punctuation">(</span>msg<span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span>
        <span class="token keyword">except</span> etimeout<span class="token punctuation">.</span>Timeout<span class="token punctuation">:</span>
            msg <span class="token operator">=</span> <span class="token string">"Failed to stop instance %(instance)s"</span> <span class="token operator">%</span> <span class="token punctuation">&#123;</span>
                <span class="token string">'instance'</span><span class="token punctuation">:</span> instance<span class="token punctuation">.</span><span class="token builtin">id</span>
            <span class="token punctuation">&#125;</span>
            self<span class="token punctuation">.</span>update_details<span class="token punctuation">(</span>msg<span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span>
            <span class="token keyword">raise</span> exception<span class="token punctuation">.</span>InstanceRecoveryFailureException<span class="token punctuation">(</span>
                message<span class="token operator">=</span>msg<span class="token punctuation">)</span>
        <span class="token keyword">finally</span><span class="token punctuation">:</span>
            <span class="token comment"># stop the periodic call, in case of exceptions or Timeout.</span>
            periodic_call<span class="token punctuation">.</span>stop<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre>

<p>参数<code>process_all_instances</code>为<code>true</code>，则所有的vm实例都执行，若该参数为<code>false</code>，则是否执行实例要根据实例的<code>metadata key &#39;HA_Enabled=True&#39; or not。</code></p>
<pre><code>instance_failure_options = [
    cfg.BoolOpt(&#39;process_all_instances&#39;,
                default=False,
                help=&quot;&quot;&quot;
Operators can decide whether all instances or only those instances which
contain metadata key &#39;HA_Enabled=True&#39; should be taken into account to
recover from instance failure events. When set to True, it will execute
instance failure recovery actions for an instance irrespective of whether
that particular instance contains metadata key &#39;HA_Enabled=True&#39; or not.
When set to False, it will only execute instance failure recovery actions
for an instance which contain metadata key &#39;HA_Enabled=True&#39;.&quot;&quot;&quot;),
]</code></pre>
<p>如果参数<code>process_all_instances</code>为<code>false</code>且vm实例的<code>metadata：HA_Enabled为false</code>，<code>not CONF.instance_failure.process_all_instances and not (strutils.bool_from_string(instance.metadata.get(&#39;HA_Enabled&#39;, False)))</code>，则跳过恢复该实例流程。</p>
<p>下面是vm几种状态的特殊处理，比如若是[‘paused’, ‘rescued’]，若状态是!= ‘stopped’且== ‘resized’。</p>
<p>再下面就是调用<code>novaclient</code>模块的<code>novaclient.stop_server</code>去stop vm实例，再调用Openstack的公共模块<code>oslo_service</code>，每隔一段时间去监测之前的<code>_wait_for_power_off</code>动作是否完成，是否超时。</p>
<p><code>masakari\engine\drivers\taskflow\instance_failure.py</code></p>
<pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">StartInstanceTask</span><span class="token punctuation">(</span>base<span class="token punctuation">.</span>MasakariTask<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> context<span class="token punctuation">,</span> novaclient<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>
        kwargs<span class="token punctuation">[</span><span class="token string">'requires'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">"instance_uuid"</span><span class="token punctuation">]</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>StartInstanceTask<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span>context<span class="token punctuation">,</span>
                                                novaclient<span class="token punctuation">,</span>
                                                <span class="token operator">**</span>kwargs<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">execute</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> instance_uuid<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""Start the instance."""</span>
        msg <span class="token operator">=</span> <span class="token string">"Starting instance: '%s'"</span> <span class="token operator">%</span> instance_uuid
        self<span class="token punctuation">.</span>update_details<span class="token punctuation">(</span>msg<span class="token punctuation">)</span>

        instance <span class="token operator">=</span> self<span class="token punctuation">.</span>novaclient<span class="token punctuation">.</span>get_server<span class="token punctuation">(</span>self<span class="token punctuation">.</span>context<span class="token punctuation">,</span> instance_uuid<span class="token punctuation">)</span>
        vm_state <span class="token operator">=</span> <span class="token builtin">getattr</span><span class="token punctuation">(</span>instance<span class="token punctuation">,</span> <span class="token string">'OS-EXT-STS:vm_state'</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> vm_state <span class="token operator">==</span> <span class="token string">'stopped'</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>novaclient<span class="token punctuation">.</span>start_server<span class="token punctuation">(</span>self<span class="token punctuation">.</span>context<span class="token punctuation">,</span> instance<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">)</span>
            msg <span class="token operator">=</span> <span class="token string">"Instance started: '%s'"</span> <span class="token operator">%</span> instance_uuid
            self<span class="token punctuation">.</span>update_details<span class="token punctuation">(</span>msg<span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            msg <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token string">"Invalid state for Instance %(instance)s. Expected state: "</span>
                   <span class="token string">"'STOPPED', Actual state: '%(actual_state)s'"</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token punctuation">&#123;</span>
                <span class="token string">'instance'</span><span class="token punctuation">:</span> instance_uuid<span class="token punctuation">,</span>
                <span class="token string">'actual_state'</span><span class="token punctuation">:</span> vm_state
            <span class="token punctuation">&#125;</span>
            self<span class="token punctuation">.</span>update_details<span class="token punctuation">(</span>msg<span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span>
            <span class="token keyword">raise</span> exception<span class="token punctuation">.</span>InstanceRecoveryFailureException<span class="token punctuation">(</span>
                message<span class="token operator">=</span>msg<span class="token punctuation">)</span></code></pre>
<p>若vm实例状态时<code>stopped</code>，则调用novaclient模块的<code>novaclient.start_server</code>方法启动vm实例，否则抛出<code>exception.InstanceRecoveryFailureException</code></p>
<p><code>masakari\engine\drivers\taskflow\instance_failure.py</code></p>
<pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">ConfirmInstanceActiveTask</span><span class="token punctuation">(</span>base<span class="token punctuation">.</span>MasakariTask<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> context<span class="token punctuation">,</span> novaclient<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>
        kwargs<span class="token punctuation">[</span><span class="token string">'requires'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">"instance_uuid"</span><span class="token punctuation">]</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>ConfirmInstanceActiveTask<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span>context<span class="token punctuation">,</span>
                                                        novaclient<span class="token punctuation">,</span>
                                                        <span class="token operator">**</span>kwargs<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">execute</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> instance_uuid<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">def</span> <span class="token function">_wait_for_active</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            new_instance <span class="token operator">=</span> self<span class="token punctuation">.</span>novaclient<span class="token punctuation">.</span>get_server<span class="token punctuation">(</span>self<span class="token punctuation">.</span>context<span class="token punctuation">,</span>
                                                      instance_uuid<span class="token punctuation">)</span>
            vm_state <span class="token operator">=</span> <span class="token builtin">getattr</span><span class="token punctuation">(</span>new_instance<span class="token punctuation">,</span> <span class="token string">'OS-EXT-STS:vm_state'</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> vm_state <span class="token operator">==</span> <span class="token string">'active'</span><span class="token punctuation">:</span>
                <span class="token keyword">raise</span> loopingcall<span class="token punctuation">.</span>LoopingCallDone<span class="token punctuation">(</span><span class="token punctuation">)</span>

        periodic_call <span class="token operator">=</span> loopingcall<span class="token punctuation">.</span>FixedIntervalLoopingCall<span class="token punctuation">(</span>
            _wait_for_active<span class="token punctuation">)</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            msg <span class="token operator">=</span> <span class="token string">"Confirming instance '%s' vm_state is ACTIVE"</span> <span class="token operator">%</span> instance_uuid
            self<span class="token punctuation">.</span>update_details<span class="token punctuation">(</span>msg<span class="token punctuation">)</span>

            <span class="token comment"># add a timeout to the periodic call.</span>
            periodic_call<span class="token punctuation">.</span>start<span class="token punctuation">(</span>interval<span class="token operator">=</span>CONF<span class="token punctuation">.</span>verify_interval<span class="token punctuation">)</span>
            etimeout<span class="token punctuation">.</span>with_timeout<span class="token punctuation">(</span>CONF<span class="token punctuation">.</span>wait_period_after_power_on<span class="token punctuation">,</span>
                                  periodic_call<span class="token punctuation">.</span>wait<span class="token punctuation">)</span>

            msg <span class="token operator">=</span> <span class="token string">"Confirmed instance '%s' vm_state is ACTIVE"</span> <span class="token operator">%</span> instance_uuid
            self<span class="token punctuation">.</span>update_details<span class="token punctuation">(</span>msg<span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span>
        <span class="token keyword">except</span> etimeout<span class="token punctuation">.</span>Timeout<span class="token punctuation">:</span>
            msg <span class="token operator">=</span> <span class="token string">"Failed to start instance %(instance)s"</span> <span class="token operator">%</span> <span class="token punctuation">&#123;</span>
                <span class="token string">'instance'</span><span class="token punctuation">:</span> instance_uuid
            <span class="token punctuation">&#125;</span>
            self<span class="token punctuation">.</span>update_details<span class="token punctuation">(</span>msg<span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span>
            <span class="token keyword">raise</span> exception<span class="token punctuation">.</span>InstanceRecoveryFailureException<span class="token punctuation">(</span>
                message<span class="token operator">=</span>msg<span class="token punctuation">)</span>
        <span class="token keyword">finally</span><span class="token punctuation">:</span>
            <span class="token comment"># stop the periodic call, in case of exceptions or Timeout.</span>
            periodic_call<span class="token punctuation">.</span>stop<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre>
<p>调用Openstack的公共模块<code>oslo_service</code>，每隔一段时间去监测之前的<code>_wait_for_active</code>动作是否完成，是否超时。</p>
<p><code>masakari/setup.cfg</code>文件对task名称的定义：</p>
<pre><code>    stop_instance_task = masakari.engine.drivers.taskflow.instance_failure:StopInstanceTask
    start_instance_task = masakari.engine.drivers.taskflow.instance_failure:StartInstanceTask
    confirm_instance_active_task = masakari.engine.drivers.taskflow.instance_failure:ConfirmInstanceActiveTask</code></pre>
<p>配置文件对流程的定义：</p>
<pre><code>    cfg.Opt(&#39;instance_failure_recovery_tasks&#39;,
            type=types.Dict(
                bounds=False,
                value_type=types.List(bounds=True,
                                      item_type=types.String(quotes=True))),
            default=&#123;&#39;pre&#39;: [&#39;stop_instance_task&#39;],
                     &#39;main&#39;: [&#39;start_instance_task&#39;],
                     &#39;post&#39;: [&#39;confirm_instance_active_task&#39;]&#125;,
            help=(&quot;&quot;&quot;
This option allows operator to customize tasks to be executed for instance
failure recovery workflow.

Provide list of strings reflecting to the task classes that should be included
to the instance failure recovery workflow. The full classname path of all task
classes should be defined in the &#39;masakari.task_flow.tasks&#39; of setup.cfg and
these classes may be implemented by OpenStack Masaskari project team, deployer
or third party.

By default below three tasks will be part of this config option:-
1. stop_instance_task
2. start_instance_task
3. confirm_instance_active_task

The allowed values for this option is comma separated dictionary of object
names in between ``&#123;`` and ``&#125;``.&quot;&quot;&quot;)),
]</code></pre>
<h1 id="节点故障处理流程"><a href="#节点故障处理流程" class="headerlink" title="节点故障处理流程"></a>节点故障处理流程</h1><p><code>masakari\engine\drivers\taskflow\host_failure.py</code></p>
<pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">DisableComputeServiceTask</span><span class="token punctuation">(</span>base<span class="token punctuation">.</span>MasakariTask<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> context<span class="token punctuation">,</span> novaclient<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>
        kwargs<span class="token punctuation">[</span><span class="token string">'requires'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">"host_name"</span><span class="token punctuation">]</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>DisableComputeServiceTask<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span>context<span class="token punctuation">,</span> novaclient<span class="token punctuation">,</span>
                                                        <span class="token operator">**</span>kwargs<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">execute</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> host_name<span class="token punctuation">)</span><span class="token punctuation">:</span>
        msg <span class="token operator">=</span> <span class="token string">"Disabling compute service on host: '%s'"</span> <span class="token operator">%</span> host_name
        self<span class="token punctuation">.</span>update_details<span class="token punctuation">(</span>msg<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>novaclient<span class="token punctuation">.</span>enable_disable_service<span class="token punctuation">(</span>self<span class="token punctuation">.</span>context<span class="token punctuation">,</span> host_name<span class="token punctuation">)</span>
        <span class="token comment"># Sleep until nova-compute service is marked as disabled.</span>
        log_msg <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token string">"Sleeping %(wait)s sec before starting recovery "</span>
               <span class="token string">"thread until nova recognizes the node down."</span><span class="token punctuation">)</span>
        LOG<span class="token punctuation">.</span>info<span class="token punctuation">(</span>log_msg<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token string">'wait'</span><span class="token punctuation">:</span> CONF<span class="token punctuation">.</span>wait_period_after_service_update<span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
        eventlet<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span>CONF<span class="token punctuation">.</span>wait_period_after_service_update<span class="token punctuation">)</span>
        msg <span class="token operator">=</span> <span class="token string">"Disabled compute service on host: '%s'"</span> <span class="token operator">%</span> host_name
        self<span class="token punctuation">.</span>update_details<span class="token punctuation">(</span>msg<span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span></code></pre>
<p><code>DisableComputeServiceTask</code>实现<code>disable</code>计算节点的计算服务</p>
<p><code>masakari\engine\drivers\taskflow\host_failure.py</code></p>
<pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">PrepareHAEnabledInstancesTask</span><span class="token punctuation">(</span>base<span class="token punctuation">.</span>MasakariTask<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""Get all HA_Enabled instances."""</span>
    default_provides <span class="token operator">=</span> <span class="token builtin">set</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">"instance_list"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> context<span class="token punctuation">,</span> novaclient<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>
        kwargs<span class="token punctuation">[</span><span class="token string">'requires'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">"host_name"</span><span class="token punctuation">]</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>PrepareHAEnabledInstancesTask<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span>context<span class="token punctuation">,</span>
                                                            novaclient<span class="token punctuation">,</span>
                                                            <span class="token operator">**</span>kwargs<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">execute</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> host_name<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">def</span> <span class="token function">_filter_instances</span><span class="token punctuation">(</span>instance_list<span class="token punctuation">)</span><span class="token punctuation">:</span>
            ha_enabled_instances <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
            non_ha_enabled_instances <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

            <span class="token keyword">for</span> instance <span class="token keyword">in</span> instance_list<span class="token punctuation">:</span>
                is_instance_ha_enabled <span class="token operator">=</span> strutils<span class="token punctuation">.</span>bool_from_string<span class="token punctuation">(</span>
                    instance<span class="token punctuation">.</span>metadata<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'HA_Enabled'</span><span class="token punctuation">,</span> <span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token keyword">if</span> CONF<span class="token punctuation">.</span>host_failure<span class="token punctuation">.</span>ignore_instances_in_error_state <span class="token keyword">and</span> <span class="token punctuation">(</span>
                        <span class="token builtin">getattr</span><span class="token punctuation">(</span>instance<span class="token punctuation">,</span> <span class="token string">"OS-EXT-STS:vm_state"</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">"error"</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                    <span class="token keyword">if</span> is_instance_ha_enabled<span class="token punctuation">:</span>
                        msg <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token string">"Ignoring recovery of HA_Enabled instance "</span>
                               <span class="token string">"'%(instance_id)s' as it is in 'error' state."</span>
                               <span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token punctuation">&#123;</span><span class="token string">'instance_id'</span><span class="token punctuation">:</span> instance<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">&#125;</span>
                        LOG<span class="token punctuation">.</span>info<span class="token punctuation">(</span>msg<span class="token punctuation">)</span>
                        self<span class="token punctuation">.</span>update_details<span class="token punctuation">(</span>msg<span class="token punctuation">,</span> <span class="token number">0.4</span><span class="token punctuation">)</span>
                    <span class="token keyword">continue</span>

                <span class="token keyword">if</span> is_instance_ha_enabled<span class="token punctuation">:</span>
                    ha_enabled_instances<span class="token punctuation">.</span>append<span class="token punctuation">(</span>instance<span class="token punctuation">)</span>
                <span class="token keyword">else</span><span class="token punctuation">:</span>
                    non_ha_enabled_instances<span class="token punctuation">.</span>append<span class="token punctuation">(</span>instance<span class="token punctuation">)</span>

            msg <span class="token operator">=</span> <span class="token string">"Total HA Enabled instances count: '%d'"</span> <span class="token operator">%</span> <span class="token builtin">len</span><span class="token punctuation">(</span>
                ha_enabled_instances<span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>update_details<span class="token punctuation">(</span>msg<span class="token punctuation">,</span> <span class="token number">0.6</span><span class="token punctuation">)</span>

            <span class="token keyword">if</span> CONF<span class="token punctuation">.</span>host_failure<span class="token punctuation">.</span>evacuate_all_instances<span class="token punctuation">:</span>
                msg <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token string">"Total Non-HA Enabled instances count: '%d'"</span> <span class="token operator">%</span> <span class="token builtin">len</span><span class="token punctuation">(</span>
                    non_ha_enabled_instances<span class="token punctuation">)</span><span class="token punctuation">)</span>
                self<span class="token punctuation">.</span>update_details<span class="token punctuation">(</span>msg<span class="token punctuation">,</span> <span class="token number">0.7</span><span class="token punctuation">)</span>

                ha_enabled_instances<span class="token punctuation">.</span>extend<span class="token punctuation">(</span>non_ha_enabled_instances<span class="token punctuation">)</span>

                msg <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token string">"All instances (HA Enabled/Non-HA Enabled) should be "</span>
                       <span class="token string">"considered for evacuation. Total count is: '%d'"</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token punctuation">(</span>
                    <span class="token builtin">len</span><span class="token punctuation">(</span>ha_enabled_instances<span class="token punctuation">)</span><span class="token punctuation">)</span>
                self<span class="token punctuation">.</span>update_details<span class="token punctuation">(</span>msg<span class="token punctuation">,</span> <span class="token number">0.8</span><span class="token punctuation">)</span>

            <span class="token keyword">return</span> ha_enabled_instances

        msg <span class="token operator">=</span> <span class="token string">"Preparing instances for evacuation"</span>
        self<span class="token punctuation">.</span>update_details<span class="token punctuation">(</span>msg<span class="token punctuation">)</span>

        instance_list <span class="token operator">=</span> self<span class="token punctuation">.</span>novaclient<span class="token punctuation">.</span>get_servers<span class="token punctuation">(</span>self<span class="token punctuation">.</span>context<span class="token punctuation">,</span> host_name<span class="token punctuation">)</span>

        msg <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token string">"Total instances running on failed host '%(host_name)s' is "</span>
               <span class="token string">"%(instance_list)d"</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token punctuation">&#123;</span><span class="token string">'host_name'</span><span class="token punctuation">:</span> host_name<span class="token punctuation">,</span>
                                       <span class="token string">'instance_list'</span><span class="token punctuation">:</span> <span class="token builtin">len</span><span class="token punctuation">(</span>instance_list<span class="token punctuation">)</span><span class="token punctuation">&#125;</span>
        self<span class="token punctuation">.</span>update_details<span class="token punctuation">(</span>msg<span class="token punctuation">,</span> <span class="token number">0.3</span><span class="token punctuation">)</span>

        instance_list <span class="token operator">=</span> _filter_instances<span class="token punctuation">(</span>instance_list<span class="token punctuation">)</span>

        <span class="token keyword">if</span> <span class="token keyword">not</span> instance_list<span class="token punctuation">:</span>
            msg <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token string">"Skipped host '%s' recovery as no instances needs to be "</span>
                   <span class="token string">"evacuated"</span> <span class="token operator">%</span> host_name<span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>update_details<span class="token punctuation">(</span>msg<span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span>
            LOG<span class="token punctuation">.</span>info<span class="token punctuation">(</span>msg<span class="token punctuation">)</span>
            <span class="token keyword">raise</span> exception<span class="token punctuation">.</span>SkipHostRecoveryException<span class="token punctuation">(</span>message<span class="token operator">=</span>msg<span class="token punctuation">)</span>

        <span class="token comment"># List of instance UUID</span>
        instance_list <span class="token operator">=</span> <span class="token punctuation">[</span>instance<span class="token punctuation">.</span><span class="token builtin">id</span> <span class="token keyword">for</span> instance <span class="token keyword">in</span> instance_list<span class="token punctuation">]</span>

        msg <span class="token operator">=</span> <span class="token string">"Instances to be evacuated are: '%s'"</span> <span class="token operator">%</span> <span class="token string">','</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>instance_list<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>update_details<span class="token punctuation">(</span>msg<span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span>

        <span class="token keyword">return</span> <span class="token punctuation">&#123;</span>
            <span class="token string">"instance_list"</span><span class="token punctuation">:</span> instance_list<span class="token punctuation">,</span>
        <span class="token punctuation">&#125;</span></code></pre>
<p><code>PrepareHAEnabledInstancesTask</code>是疏散前的准备，准备哪些实例是需要疏散的。</p>
<p>具体实现：调用<code>novaclient</code>的<code>novaclient.get_servers</code>方法获得故障节点<code>hostname</code>上的所有的vm实例，存放在<code>instance_list</code>列表，调用过滤方法<code>_filter_instances</code>过滤后的vm实例，存放在<code>instance_list</code>列表，获取<code>instance_list</code>列表中的所有的<code>instance</code>的<code>id</code>再存放于<code>instance_list</code>列表。</p>
<p><code>_filter_instances</code>方法对host上所有的实例做了过滤，返回需要疏散的实例。<br>具体实现：<br>（1）先将所有实例分为三类，一类 <code>CONF.host_failure.ignore_instances_in_error_state</code>设定为<code>true</code>且为<code>error</code>状态的实例，这一类直接跳过；第二类metadata包含<code>HA_Enabled</code>的实例，保存在数组<code>ha_enabled_instances</code>中；第三类是metadata不包含HA_Enabled的实例，保存在数组<code>non_ha_enabled_instances</code>中。<br>（2）若<code>CONF.host_failure.evacuate_all_instances</code>设定为<code>true</code>，则返回保存在数组<code>ha_enabled_instances</code>和<code>non_ha_enabled_instances</code>合并后的数组，若<code>CONF.host_failure.evacuate_all_instances</code>设定为<code>false</code>，则只返回<code>ha_enabled_instances</code>数组。</p>
<p><code>masakari\engine\drivers\taskflow\host_failure.py</code></p>
<pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">EvacuateInstancesTask</span><span class="token punctuation">(</span>base<span class="token punctuation">.</span>MasakariTask<span class="token punctuation">)</span><span class="token punctuation">:</span>

    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> context<span class="token punctuation">,</span> novaclient<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>
        kwargs<span class="token punctuation">[</span><span class="token string">'requires'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">"host_name"</span><span class="token punctuation">,</span> <span class="token string">"instance_list"</span><span class="token punctuation">]</span>
        self<span class="token punctuation">.</span>update_host_method <span class="token operator">=</span> kwargs<span class="token punctuation">[</span><span class="token string">'update_host_method'</span><span class="token punctuation">]</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>EvacuateInstancesTask<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span>context<span class="token punctuation">,</span> novaclient<span class="token punctuation">,</span>
                                                    <span class="token operator">**</span>kwargs<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">_get_state_and_host_of_instance</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> context<span class="token punctuation">,</span> instance<span class="token punctuation">)</span><span class="token punctuation">:</span>
        new_instance <span class="token operator">=</span> self<span class="token punctuation">.</span>novaclient<span class="token punctuation">.</span>get_server<span class="token punctuation">(</span>context<span class="token punctuation">,</span> instance<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">)</span>
        instance_host <span class="token operator">=</span> <span class="token builtin">getattr</span><span class="token punctuation">(</span>new_instance<span class="token punctuation">,</span>
                                <span class="token string">"OS-EXT-SRV-ATTR:hypervisor_hostname"</span><span class="token punctuation">)</span>
        old_vm_state <span class="token operator">=</span> <span class="token builtin">getattr</span><span class="token punctuation">(</span>instance<span class="token punctuation">,</span> <span class="token string">"OS-EXT-STS:vm_state"</span><span class="token punctuation">)</span>
        new_vm_state <span class="token operator">=</span> <span class="token builtin">getattr</span><span class="token punctuation">(</span>new_instance<span class="token punctuation">,</span> <span class="token string">"OS-EXT-STS:vm_state"</span><span class="token punctuation">)</span>

        <span class="token keyword">return</span> <span class="token punctuation">(</span>old_vm_state<span class="token punctuation">,</span> new_vm_state<span class="token punctuation">,</span> instance_host<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">_stop_after_evacuation</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> context<span class="token punctuation">,</span> instance<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">def</span> <span class="token function">_wait_for_stop_confirmation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            old_vm_state<span class="token punctuation">,</span> new_vm_state<span class="token punctuation">,</span> instance_host <span class="token operator">=</span> <span class="token punctuation">(</span>
                self<span class="token punctuation">.</span>_get_state_and_host_of_instance<span class="token punctuation">(</span>context<span class="token punctuation">,</span> instance<span class="token punctuation">)</span><span class="token punctuation">)</span>

            <span class="token keyword">if</span> new_vm_state <span class="token operator">==</span> <span class="token string">'stopped'</span><span class="token punctuation">:</span>
                <span class="token keyword">raise</span> loopingcall<span class="token punctuation">.</span>LoopingCallDone<span class="token punctuation">(</span><span class="token punctuation">)</span>

        periodic_call_stopped <span class="token operator">=</span> loopingcall<span class="token punctuation">.</span>FixedIntervalLoopingCall<span class="token punctuation">(</span>
            _wait_for_stop_confirmation<span class="token punctuation">)</span>

        <span class="token keyword">try</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>novaclient<span class="token punctuation">.</span>stop_server<span class="token punctuation">(</span>context<span class="token punctuation">,</span> instance<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">)</span>
            <span class="token comment"># confirm instance is stopped after recovery</span>
            periodic_call_stopped<span class="token punctuation">.</span>start<span class="token punctuation">(</span>interval<span class="token operator">=</span>CONF<span class="token punctuation">.</span>verify_interval<span class="token punctuation">)</span>
            etimeout<span class="token punctuation">.</span>with_timeout<span class="token punctuation">(</span>
                CONF<span class="token punctuation">.</span>wait_period_after_power_off<span class="token punctuation">,</span>
                periodic_call_stopped<span class="token punctuation">.</span>wait<span class="token punctuation">)</span>
        <span class="token keyword">except</span> etimeout<span class="token punctuation">.</span>Timeout<span class="token punctuation">:</span>
            <span class="token keyword">with</span> excutils<span class="token punctuation">.</span>save_and_reraise_exception<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                periodic_call_stopped<span class="token punctuation">.</span>stop<span class="token punctuation">(</span><span class="token punctuation">)</span>
                msg <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token string">"Instance '%(uuid)s' is successfully evacuated but "</span>
                       <span class="token string">"failed to stop."</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token punctuation">&#123;</span><span class="token string">'uuid'</span><span class="token punctuation">:</span> instance<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">&#125;</span>
                LOG<span class="token punctuation">.</span>warning<span class="token punctuation">(</span>msg<span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            periodic_call_stopped<span class="token punctuation">.</span>stop<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">_evacuate_and_confirm</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> context<span class="token punctuation">,</span> instance<span class="token punctuation">,</span> host_name<span class="token punctuation">,</span>
                              failed_evacuation_instances<span class="token punctuation">,</span>
                              reserved_host<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># Before locking the instance check whether it is already locked</span>
        <span class="token comment"># by user, if yes don't lock the instance</span>
        instance_already_locked <span class="token operator">=</span> self<span class="token punctuation">.</span>novaclient<span class="token punctuation">.</span>get_server<span class="token punctuation">(</span>
            context<span class="token punctuation">,</span> instance<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">)</span><span class="token punctuation">.</span>locked

        <span class="token keyword">if</span> <span class="token keyword">not</span> instance_already_locked<span class="token punctuation">:</span>
            <span class="token comment"># lock the instance so that until evacuation and confirmation</span>
            <span class="token comment"># is not complete, user won't be able to perform any actions</span>
            <span class="token comment"># on the instance.</span>
            self<span class="token punctuation">.</span>novaclient<span class="token punctuation">.</span>lock_server<span class="token punctuation">(</span>context<span class="token punctuation">,</span> instance<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">)</span>

        <span class="token keyword">def</span> <span class="token function">_wait_for_evacuation_confirmation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            old_vm_state<span class="token punctuation">,</span> new_vm_state<span class="token punctuation">,</span> instance_host <span class="token operator">=</span> <span class="token punctuation">(</span>
                self<span class="token punctuation">.</span>_get_state_and_host_of_instance<span class="token punctuation">(</span>context<span class="token punctuation">,</span> instance<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> instance_host <span class="token operator">!=</span> host_name<span class="token punctuation">:</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>old_vm_state <span class="token operator">==</span> <span class="token string">'error'</span> <span class="token keyword">and</span>
                    new_vm_state <span class="token operator">==</span> <span class="token string">'active'</span><span class="token punctuation">)</span> <span class="token keyword">or</span>
                        old_vm_state <span class="token operator">==</span> new_vm_state<span class="token punctuation">)</span><span class="token punctuation">:</span>
                    <span class="token keyword">raise</span> loopingcall<span class="token punctuation">.</span>LoopingCallDone<span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token keyword">def</span> <span class="token function">_wait_for_evacuation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            periodic_call <span class="token operator">=</span> loopingcall<span class="token punctuation">.</span>FixedIntervalLoopingCall<span class="token punctuation">(</span>
                _wait_for_evacuation_confirmation<span class="token punctuation">)</span>

            <span class="token keyword">try</span><span class="token punctuation">:</span>
                <span class="token comment"># add a timeout to the periodic call.</span>
                periodic_call<span class="token punctuation">.</span>start<span class="token punctuation">(</span>interval<span class="token operator">=</span>CONF<span class="token punctuation">.</span>verify_interval<span class="token punctuation">)</span>
                etimeout<span class="token punctuation">.</span>with_timeout<span class="token punctuation">(</span>
                    CONF<span class="token punctuation">.</span>wait_period_after_evacuation<span class="token punctuation">,</span>
                    periodic_call<span class="token punctuation">.</span>wait<span class="token punctuation">)</span>
            <span class="token keyword">except</span> etimeout<span class="token punctuation">.</span>Timeout<span class="token punctuation">:</span>
                <span class="token comment"># Instance is not evacuated in the expected time_limit.</span>
                failed_evacuation_instances<span class="token punctuation">.</span>append<span class="token punctuation">(</span>instance<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">)</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                <span class="token comment"># stop the periodic call, in case of exceptions or</span>
                <span class="token comment"># Timeout.</span>
                periodic_call<span class="token punctuation">.</span>stop<span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token keyword">try</span><span class="token punctuation">:</span>
            vm_state <span class="token operator">=</span> <span class="token builtin">getattr</span><span class="token punctuation">(</span>instance<span class="token punctuation">,</span> <span class="token string">"OS-EXT-STS:vm_state"</span><span class="token punctuation">)</span>
            task_state <span class="token operator">=</span> <span class="token builtin">getattr</span><span class="token punctuation">(</span>instance<span class="token punctuation">,</span> <span class="token string">"OS-EXT-STS:task_state"</span><span class="token punctuation">)</span>

            <span class="token comment"># Nova evacuates an instance only when vm_state is in active,</span>
            <span class="token comment"># stopped or error state. If an instance is in other than active,</span>
            <span class="token comment"># error and stopped vm_state, masakari resets the instance state</span>
            <span class="token comment"># to *error* so that the instance can be evacuated.</span>
            stop_instance <span class="token operator">=</span> <span class="token boolean">True</span>
            <span class="token keyword">if</span> vm_state <span class="token keyword">not</span> <span class="token keyword">in</span> <span class="token punctuation">[</span><span class="token string">'active'</span><span class="token punctuation">,</span> <span class="token string">'error'</span><span class="token punctuation">,</span> <span class="token string">'stopped'</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
                self<span class="token punctuation">.</span>novaclient<span class="token punctuation">.</span>reset_instance_state<span class="token punctuation">(</span>context<span class="token punctuation">,</span> instance<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">)</span>
                instance <span class="token operator">=</span> self<span class="token punctuation">.</span>novaclient<span class="token punctuation">.</span>get_server<span class="token punctuation">(</span>context<span class="token punctuation">,</span> instance<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">)</span>
                power_state <span class="token operator">=</span> <span class="token builtin">getattr</span><span class="token punctuation">(</span>instance<span class="token punctuation">,</span> <span class="token string">"OS-EXT-STS:power_state"</span><span class="token punctuation">)</span>
                <span class="token keyword">if</span> vm_state <span class="token operator">==</span> <span class="token string">'resized'</span> <span class="token keyword">and</span> power_state <span class="token operator">!=</span> SHUTDOWN<span class="token punctuation">:</span>
                    stop_instance <span class="token operator">=</span> <span class="token boolean">False</span>

            <span class="token keyword">elif</span> task_state <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
                <span class="token comment"># Nova fails evacuation when the instance's task_state is not</span>
                <span class="token comment"># none. In this case, masakari resets the instance's vm_state</span>
                <span class="token comment"># to 'error' and task_state to none.</span>
                self<span class="token punctuation">.</span>novaclient<span class="token punctuation">.</span>reset_instance_state<span class="token punctuation">(</span>context<span class="token punctuation">,</span> instance<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">)</span>
                instance <span class="token operator">=</span> self<span class="token punctuation">.</span>novaclient<span class="token punctuation">.</span>get_server<span class="token punctuation">(</span>context<span class="token punctuation">,</span> instance<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">)</span>
                <span class="token keyword">if</span> vm_state <span class="token operator">==</span> <span class="token string">'active'</span><span class="token punctuation">:</span>
                    stop_instance <span class="token operator">=</span> <span class="token boolean">False</span>

            <span class="token comment"># evacuate the instance</span>
            self<span class="token punctuation">.</span>novaclient<span class="token punctuation">.</span>evacuate_instance<span class="token punctuation">(</span>context<span class="token punctuation">,</span> instance<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">,</span>
                                              target<span class="token operator">=</span>reserved_host<span class="token punctuation">)</span>

            _wait_for_evacuation<span class="token punctuation">(</span><span class="token punctuation">)</span>

            <span class="token keyword">if</span> vm_state <span class="token operator">!=</span> <span class="token string">'active'</span><span class="token punctuation">:</span>
                <span class="token keyword">if</span> stop_instance<span class="token punctuation">:</span>
                    self<span class="token punctuation">.</span>_stop_after_evacuation<span class="token punctuation">(</span>self<span class="token punctuation">.</span>context<span class="token punctuation">,</span> instance<span class="token punctuation">)</span>
                    <span class="token comment"># If the instance was in 'error' state before failure</span>
                    <span class="token comment"># it should be set to 'error' after recovery.</span>
                    <span class="token keyword">if</span> vm_state <span class="token operator">==</span> <span class="token string">'error'</span><span class="token punctuation">:</span>
                        self<span class="token punctuation">.</span>novaclient<span class="token punctuation">.</span>reset_instance_state<span class="token punctuation">(</span>
                            context<span class="token punctuation">,</span> instance<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">)</span>
        <span class="token keyword">except</span> etimeout<span class="token punctuation">.</span>Timeout<span class="token punctuation">:</span>
            <span class="token comment"># Instance is not stop in the expected time_limit.</span>
            failed_evacuation_instances<span class="token punctuation">.</span>append<span class="token punctuation">(</span>instance<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">)</span>
        <span class="token keyword">except</span> Exception<span class="token punctuation">:</span>
            <span class="token comment"># Exception is raised while resetting instance state or</span>
            <span class="token comment"># evacuating the instance itself.</span>
            failed_evacuation_instances<span class="token punctuation">.</span>append<span class="token punctuation">(</span>instance<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">)</span>
        <span class="token keyword">finally</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span> <span class="token keyword">not</span> instance_already_locked<span class="token punctuation">:</span>
                <span class="token comment"># Unlock the server after evacuation and confirmation</span>
                self<span class="token punctuation">.</span>novaclient<span class="token punctuation">.</span>unlock_server<span class="token punctuation">(</span>context<span class="token punctuation">,</span> instance<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">execute</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> host_name<span class="token punctuation">,</span> instance_list<span class="token punctuation">,</span> reserved_host<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        msg <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token string">"Start evacuation of instances from failed host '%(host_name)s'"</span>
               <span class="token string">", instance uuids are: '%(instance_list)s'"</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token punctuation">&#123;</span>
            <span class="token string">'host_name'</span><span class="token punctuation">:</span> host_name<span class="token punctuation">,</span> <span class="token string">'instance_list'</span><span class="token punctuation">:</span> <span class="token string">','</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>instance_list<span class="token punctuation">)</span><span class="token punctuation">&#125;</span>
        self<span class="token punctuation">.</span>update_details<span class="token punctuation">(</span>msg<span class="token punctuation">)</span>

        <span class="token keyword">def</span> <span class="token function">_do_evacuate</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> host_name<span class="token punctuation">,</span> instance_list<span class="token punctuation">,</span>
                         reserved_host<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            failed_evacuation_instances <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

            <span class="token keyword">if</span> reserved_host<span class="token punctuation">:</span>
                msg <span class="token operator">=</span> <span class="token string">"Enabling reserved host: '%s'"</span> <span class="token operator">%</span> reserved_host
                self<span class="token punctuation">.</span>update_details<span class="token punctuation">(</span>msg<span class="token punctuation">,</span> <span class="token number">0.1</span><span class="token punctuation">)</span>
                <span class="token keyword">if</span> CONF<span class="token punctuation">.</span>host_failure<span class="token punctuation">.</span>add_reserved_host_to_aggregate<span class="token punctuation">:</span>
                    <span class="token comment"># Assign reserved_host to an aggregate to which the failed</span>
                    <span class="token comment"># compute host belongs to.</span>
                    aggregates <span class="token operator">=</span> self<span class="token punctuation">.</span>novaclient<span class="token punctuation">.</span>get_aggregate_list<span class="token punctuation">(</span>context<span class="token punctuation">)</span>
                    <span class="token keyword">for</span> aggregate <span class="token keyword">in</span> aggregates<span class="token punctuation">:</span>
                        <span class="token keyword">if</span> host_name <span class="token keyword">in</span> aggregate<span class="token punctuation">.</span>hosts<span class="token punctuation">:</span>
                            <span class="token keyword">try</span><span class="token punctuation">:</span>
                                msg <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token string">"Add host %(reserved_host)s to "</span>
                                       <span class="token string">"aggregate %(aggregate)s"</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token punctuation">&#123;</span>
                                    <span class="token string">'reserved_host'</span><span class="token punctuation">:</span> reserved_host<span class="token punctuation">,</span>
                                    <span class="token string">'aggregate'</span><span class="token punctuation">:</span> aggregate<span class="token punctuation">.</span>name<span class="token punctuation">&#125;</span>
                                self<span class="token punctuation">.</span>update_details<span class="token punctuation">(</span>msg<span class="token punctuation">,</span> <span class="token number">0.2</span><span class="token punctuation">)</span>

                                self<span class="token punctuation">.</span>novaclient<span class="token punctuation">.</span>add_host_to_aggregate<span class="token punctuation">(</span>
                                    context<span class="token punctuation">,</span> reserved_host<span class="token punctuation">,</span> aggregate<span class="token punctuation">)</span>
                                msg <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token string">"Added host %(reserved_host)s to "</span>
                                       <span class="token string">"aggregate %(aggregate)s"</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token punctuation">&#123;</span>
                                    <span class="token string">'reserved_host'</span><span class="token punctuation">:</span> reserved_host<span class="token punctuation">,</span>
                                    <span class="token string">'aggregate'</span><span class="token punctuation">:</span> aggregate<span class="token punctuation">.</span>name<span class="token punctuation">&#125;</span>
                                self<span class="token punctuation">.</span>update_details<span class="token punctuation">(</span>msg<span class="token punctuation">,</span> <span class="token number">0.3</span><span class="token punctuation">)</span>
                            <span class="token keyword">except</span> exception<span class="token punctuation">.</span>Conflict<span class="token punctuation">:</span>
                                msg <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token string">"Host '%(reserved_host)s' already has "</span>
                                       <span class="token string">"been added to aggregate "</span>
                                       <span class="token string">"'%(aggregate)s'."</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token punctuation">&#123;</span>
                                    <span class="token string">'reserved_host'</span><span class="token punctuation">:</span> reserved_host<span class="token punctuation">,</span>
                                    <span class="token string">'aggregate'</span><span class="token punctuation">:</span> aggregate<span class="token punctuation">.</span>name<span class="token punctuation">&#125;</span>
                                self<span class="token punctuation">.</span>update_details<span class="token punctuation">(</span>msg<span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span>
                                LOG<span class="token punctuation">.</span>info<span class="token punctuation">(</span>msg<span class="token punctuation">)</span>

                            <span class="token comment"># A failed compute host can be associated with</span>
                            <span class="token comment"># multiple aggregates but operators will not</span>
                            <span class="token comment"># associate it with multiple aggregates in real</span>
                            <span class="token comment"># deployment so adding reserved_host to the very</span>
                            <span class="token comment"># first aggregate from the list.</span>
                            <span class="token keyword">break</span>

                self<span class="token punctuation">.</span>novaclient<span class="token punctuation">.</span>enable_disable_service<span class="token punctuation">(</span>
                    context<span class="token punctuation">,</span> reserved_host<span class="token punctuation">,</span> enable<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>

                <span class="token comment"># Set reserved property of reserved_host to False</span>
                self<span class="token punctuation">.</span>update_host_method<span class="token punctuation">(</span>self<span class="token punctuation">.</span>context<span class="token punctuation">,</span> reserved_host<span class="token punctuation">)</span>

            thread_pool <span class="token operator">=</span> greenpool<span class="token punctuation">.</span>GreenPool<span class="token punctuation">(</span>
                CONF<span class="token punctuation">.</span>host_failure_recovery_threads<span class="token punctuation">)</span>

            <span class="token keyword">for</span> instance_id <span class="token keyword">in</span> instance_list<span class="token punctuation">:</span>
                msg <span class="token operator">=</span> <span class="token string">"Evacuation of instance started: '%s'"</span> <span class="token operator">%</span> instance_id
                self<span class="token punctuation">.</span>update_details<span class="token punctuation">(</span>msg<span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">)</span>
                instance <span class="token operator">=</span> self<span class="token punctuation">.</span>novaclient<span class="token punctuation">.</span>get_server<span class="token punctuation">(</span>self<span class="token punctuation">.</span>context<span class="token punctuation">,</span>
                                                      instance_id<span class="token punctuation">)</span>
                thread_pool<span class="token punctuation">.</span>spawn_n<span class="token punctuation">(</span>self<span class="token punctuation">.</span>_evacuate_and_confirm<span class="token punctuation">,</span> context<span class="token punctuation">,</span>
                                    instance<span class="token punctuation">,</span> host_name<span class="token punctuation">,</span>
                                    failed_evacuation_instances<span class="token punctuation">,</span>
                                    reserved_host<span class="token punctuation">)</span>

            thread_pool<span class="token punctuation">.</span>waitall<span class="token punctuation">(</span><span class="token punctuation">)</span>

            evacuated_instances <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span><span class="token builtin">set</span><span class="token punctuation">(</span>instance_list<span class="token punctuation">)</span><span class="token punctuation">.</span>difference<span class="token punctuation">(</span><span class="token builtin">set</span><span class="token punctuation">(</span>
                failed_evacuation_instances<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

            <span class="token keyword">if</span> evacuated_instances<span class="token punctuation">:</span>
                evacuated_instances<span class="token punctuation">.</span>sort<span class="token punctuation">(</span><span class="token punctuation">)</span>
                msg <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token string">"Successfully evacuate instances '%(instance_list)s' "</span>
                       <span class="token string">"from host '%(host_name)s'"</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token punctuation">&#123;</span>
                    <span class="token string">'instance_list'</span><span class="token punctuation">:</span> <span class="token string">','</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>evacuated_instances<span class="token punctuation">)</span><span class="token punctuation">,</span>
                    <span class="token string">'host_name'</span><span class="token punctuation">:</span> host_name<span class="token punctuation">&#125;</span>
                self<span class="token punctuation">.</span>update_details<span class="token punctuation">(</span>msg<span class="token punctuation">,</span> <span class="token number">0.7</span><span class="token punctuation">)</span>

            <span class="token keyword">if</span> failed_evacuation_instances<span class="token punctuation">:</span>
                msg <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token string">"Failed to evacuate instances "</span>
                       <span class="token string">"'%(failed_evacuation_instances)s' from host "</span>
                       <span class="token string">"'%(host_name)s'"</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token punctuation">&#123;</span>
                    <span class="token string">'failed_evacuation_instances'</span><span class="token punctuation">:</span>
                        <span class="token string">','</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>failed_evacuation_instances<span class="token punctuation">)</span><span class="token punctuation">,</span>
                    <span class="token string">'host_name'</span><span class="token punctuation">:</span> host_name<span class="token punctuation">&#125;</span>
                self<span class="token punctuation">.</span>update_details<span class="token punctuation">(</span>msg<span class="token punctuation">,</span> <span class="token number">0.7</span><span class="token punctuation">)</span>
                <span class="token keyword">raise</span> exception<span class="token punctuation">.</span>HostRecoveryFailureException<span class="token punctuation">(</span>
                    message<span class="token operator">=</span>msg<span class="token punctuation">)</span>

            msg <span class="token operator">=</span> <span class="token string">"Evacuation process completed!"</span>
            self<span class="token punctuation">.</span>update_details<span class="token punctuation">(</span>msg<span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span>

        lock_name <span class="token operator">=</span> reserved_host <span class="token keyword">if</span> reserved_host <span class="token keyword">else</span> <span class="token boolean">None</span>

        <span class="token decorator annotation punctuation">@utils<span class="token punctuation">.</span>synchronized</span><span class="token punctuation">(</span>lock_name<span class="token punctuation">)</span>
        <span class="token keyword">def</span> <span class="token function">do_evacuate_with_reserved_host</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> host_name<span class="token punctuation">,</span> instance_list<span class="token punctuation">,</span>
                                           reserved_host<span class="token punctuation">)</span><span class="token punctuation">:</span>
            _do_evacuate<span class="token punctuation">(</span>self<span class="token punctuation">.</span>context<span class="token punctuation">,</span> host_name<span class="token punctuation">,</span> instance_list<span class="token punctuation">,</span>
                         reserved_host<span class="token operator">=</span>reserved_host<span class="token punctuation">)</span>

        <span class="token keyword">if</span> lock_name<span class="token punctuation">:</span>
            do_evacuate_with_reserved_host<span class="token punctuation">(</span>self<span class="token punctuation">.</span>context<span class="token punctuation">,</span> host_name<span class="token punctuation">,</span>
                                           instance_list<span class="token punctuation">,</span> reserved_host<span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            <span class="token comment"># No need to acquire lock on reserved_host when recovery_method is</span>
            <span class="token comment"># 'auto' as the selection of compute host will be decided by nova.</span>
            _do_evacuate<span class="token punctuation">(</span>self<span class="token punctuation">.</span>context<span class="token punctuation">,</span> host_name<span class="token punctuation">,</span> instance_list<span class="token punctuation">)</span></code></pre>
<p><code>EvacuateInstancesTask</code>实现对故障节点上的需要疏散的实例做疏散操作。其中分2种情况，是否指定<code>reserved_host</code>，若指定则疏散到该<code>reserved_host</code>，若无，由<code>nova-scheduler</code>选择疏散的目的节点。<br>具体实现：<br>（1）若<code>CONF.host_failure.add_reserved_host_to_aggregate</code>为true，则将<code>reserved_host</code>添加到故障节点所属的主机组。<br>（2）调用<code>novaclient</code>模块的<code>novaclient.enable_disable_service(context, reserved_host, enable=True)</code>方法将<code>reserved_host</code>的计算服务从disable状态修改为enable状态<br>（3）调用<code>update_host_method</code>方法将<code>reserved_host</code>的reserved属性设定为false<br>（4）根据配置文件<code>CONF.host_failure_recovery_threads</code>设定的线程数启动对应的线程数，来疏散<code>instance_list</code>数组里的实例<br>（5）等待所有疏散线程结束<br>（6）给出所有疏散的实例和所有未疏散的实例</p>
<p>其中第（4）步，多线程疏散方法<code>_evacuate_and_confirm</code>具体实现：<br>（a）调用<code>novaclient</code>模块获取vm实例是否为locked状态<code>novaclient.get_server(context, instance.id).locked</code><br>（b）若不是<code>locked</code>状态则调用<code>novaclient.lock_server(context, instance.id)</code>方法将vm实例锁定，目的是确保对实例疏散过程中，用户不能对该实例有任何操作。<br>（c）因为疏散支持对<code>error</code>，<code>active</code>，<code>stopped</code>三种状态的vm做疏散，若不是这三种状态将实例reset成这三种状态。<br>（d）执行对vm实例的疏散<br>（e）等待实例疏散的完成</p>
<p><code>masakari/setup.cfg</code>文件对task名称的定义：</p>
<pre><code>masakari.task_flow.tasks =
    disable_compute_service_task = masakari.engine.drivers.taskflow.host_failure:DisableComputeServiceTask
    prepare_HA_enabled_instances_task = masakari.engine.drivers.taskflow.host_failure:PrepareHAEnabledInstancesTask
    evacuate_instances_task = masakari.engine.drivers.taskflow.host_failure:EvacuateInstancesTask</code></pre>
<p>配置文件对流程的定义：</p>
<pre><code>    cfg.Opt(&#39;host_auto_failure_recovery_tasks&#39;,
            type=types.Dict(
                bounds=False,
                value_type=types.List(bounds=True,
                                      item_type=types.String(quotes=True))),
            default=&#123;&#39;pre&#39;: [&#39;disable_compute_service_task&#39;],
                     &#39;main&#39;: [&#39;prepare_HA_enabled_instances_task&#39;],
                     &#39;post&#39;: [&#39;evacuate_instances_task&#39;]&#125;,
            help=(&quot;&quot;&quot;
This option allows operator to customize tasks to be executed for host failure
auto recovery workflow.

Provide list of strings reflecting to the task classes that should be included
to the host failure recovery workflow. The full classname path of all task
classes should be defined in the &#39;masakari.task_flow.tasks&#39; of setup.cfg and
these classes may be implemented by OpenStack Masaskari project team, deployer
or third party.

By default below three tasks will be part of this config option:-
1. disable_compute_service_task
2. prepare_HA_enabled_instances_task
3. evacuate_instances_task

The allowed values for this option is comma separated dictionary of object
names in between ``&#123;`` and ``&#125;``.&quot;&quot;&quot;)),
]</code></pre>

      
       <hr><span style="font-style: italic;color: gray;"> 转载请注明来源，欢迎指出任何有错误或不够清晰的表达。可以邮件至 backendcloud@gmail.com </span>
    </div>
</article>







    




    </div>
    <div class="copyright">
        <div class="wechat_OA">
	<span>欢迎您扫一扫下面的微信公众号对"后端云"进行订阅！</span>
	<br>
    <!-- 这里添加你的二维码图片 -->
	<img src ="/img/wechat-dingyuehao.jpg">
</div>

<p class="footer-entry"><span class="miit">
                <img src="/img/gov.png" title="中华人民共和国工业和信息化部">
                <a target="_blank" rel="noopener" href="http://beian.miit.gov.cn/">苏ICP备15031601-2号</a>
        </span>
    
    ©2017-2022 后端云
</p>

    </div>
    <div class="full-toc">
        <button class="full" data-title="切换全屏 快捷键 s"><span class="min "></span></button>
<a class="" id="rocket" ></a>

    </div>
</div>

</body>
<script src="/js/jquery.pjax.js?v=1.1.0" ></script>

<script src="/js/script.js?v=1.1.0" ></script>
<script>
    var img_resize = 'default';
    function initArticle() {
        /*渲染对应的表格样式*/
        
            $("#post .pjax table").addClass("green_title");
        

        /*渲染打赏样式*/
        

        /*高亮代码块行号*/
        

        /*访问数量*/
        
        $.getScript("//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js");
        

        /*代码高亮，行号对齐*/
        $('.pre-numbering').css('line-height',$('.has-numbering').css('line-height'));

        
        
    }

    /*打赏页面隐藏与展示*/
    

</script>

<!--加入行号的高亮代码块样式-->

<!--自定义样式设置-->
<style>
    
    
    .nav {
        width: 542px;
    }
    .nav.fullscreen {
        margin-left: -542px;
    }
    .nav-left {
        width: 120px;
    }
    
    
    @media screen and (max-width: 1468px) {
        .nav {
            width: 492px;
        }
        .nav.fullscreen {
            margin-left: -492px;
        }
        .nav-left {
            width: 100px;
        }
    }
    
    
    @media screen and (max-width: 1024px) {
        .nav {
            width: 492px;
            margin-left: -492px
        }
        .nav.fullscreen {
            margin-left: 0;
        }
    }
    
    @media screen and (max-width: 426px) {
        .nav {
            width: 100%;
        }
        .nav-left {
            width: 100%;
        }
    }
    
    
    .nav-right .title-list nav a .post-title, .nav-right .title-list #local-search-result a .post-title {
        color: #383636;
    }
    
    
    .nav-right .title-list nav a .post-date, .nav-right .title-list #local-search-result a .post-date {
        color: #5e5e5f;
    }
    
    
    .nav-right nav a.hover, #local-search-result a.hover{
        background-color: #e2e0e0;
    }
    
    

    /*列表样式*/
    

    /* 背景图样式 */
    
    


    /*引用块样式*/
    

    /*文章列表背景图*/
    

    
</style>







</html>
