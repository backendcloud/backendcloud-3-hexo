---
title: kubevirtci-image-init-script（workinprocess）
readmore: true
date: 2022-07-19 12:40:13
categories: 云原生
tags:
- KubeVirt CI
---


virt-sysprep 初始化镜像有时候不完全满足需求，需要额外初始化步骤。virt-sysprep执行后，往往还需要执行些脚本辅助清理初始化工作。

virt-sysprep参考 {% post_link kubevirtci-virt-sysprep %} 

## 清理 bash-history
```bash
#!/usr/bin/env bash
#
# Remove bash history for root and system users
set -o errexit

roots_hist="$(find /root -type f -name .bash_history)"
users_hist="$(find /home -type f -name .bash_history | tr -s '\n' ' ')"

rm -f ${roots_hist} ${users_hist}

exit 0
```
> root只有一个，user往往有多个，将换行替换成空格作为rm命令的参数

## 清理 cloud-init
```bash
#!/usr/bin/env bash
#
# Remove all cloud-init run-time data and logs
#
# The removal completely resets cloud-init. When the instance is next
# started cloud-init will run all configured modules as if running for the
# first time
set -o errexit

rm -rf /var/lib/cloud/*
rm -f /var/log/cloud-init.log

exit 0
```

## 清理系统崩溃的dump数据
```bash
#!/usr/bin/env bash
#
# Remove crash data generated by kexec-tools
set -o errexit

crash_data_location=(
    "/var/crash/*"
    "/var/log/dump/*"
)

# Include hidden files in glob
shopt -s nullglob dotglob

for crash_data in ${crash_data_location[@]}
do
    rm -rf ${crash_data}
done

exit 0
```
> `shopt -s nullglob dotglob`为了`rm -rf *`可以包含隐藏文件

# 清理dhcp-client数据
```bash
#!/usr/bin/env bash
#
# Remove DHCP client lease information. Note that Debian 10, and possibly
# other OSes, now write a machine specific DUID (DHCP Unique ID) to the
# leases file
set -o errexit

lease_data_locations=(
    "/var/lib/dhclient/*"
    "/var/lib/dhcp/*"
)

# Include hidden files in glob
shopt -s nullglob dotglob

# Ensure all interfaces are down prior to removing the leases file.
# Otherwise the file is recreated by ifdown/dhclient
for iface in $(ls /sys/class/net/ | grep -v lo); do
    # Wait for each interface to be taken down. Timeout after 20 secs
    timer=0
    while grep up "/sys/class/net/${iface}/operstate" &>/dev/null && \
        [[ timer -lt 20 ]]; do
        sleep 1
        let timer=${timer}+1
    done

    # If the interface is still up it is likely something has gone wrong
    # with the usual procedures that take the interface down at shutdown.
    # Make a best effort attempt to take the interface down manually
    # temporarily ignoring errors
    if grep up "/sys/class/net/${iface}/operstate" &>/dev/null; then
        set +o errexit
        ifdown ${iface}
        set -o errexit
    fi

    # Some implementations start the dhcp client when the interface is taken
    # down (even if the interface is statically configured). It is the dhcp
    # client that writes out to the leases file when the interface goes
    # down. Kill the client as a precautionary measure to prevent further
    # interference. Ignore errors in case the dhclient exits between
    # obtaining its pid and killing it
    pid="$(ps aux | grep /sbin/dhclient | grep "${iface}" | tr -s " " | \
        cut -d' ' -f2)"
    if [ "x${pid}" != "x" ]; then
        set +o errexit
        kill -9 "${pid}"
        set -o errexit
    fi
done

# Now that all interfaces are down remove all lease files
for lease_file in ${lease_data_locations[@]}; do
    rm -f ${lease_file}
done

exit 0
```
> 设定timeout为20秒，等待interface down，若还没down则通过ifdown命令down掉，网口down的时候可能dhcpclient会起进程，kill掉对应网口的dhcpclient进程后进入清理文件的工作。

## 清理防火墙规则和配置
```bash
#!/usr/bin/env bash
#
# Remove any custom firewall rules or firewalld configuration
#
# Modern systems typically make use of the dynamic firewall daemon
# firewalld which provides many advantages and additional features over
# more traditional approaches. Customisation of the systems firewall rules
# it handled through user space tools that output configuration
# customisations to /etc/firewalld/zones and /etc/firewalld/services.
# Deleting these files will remove any custom configuration from the
# system
#
# Older systems or other firewall implementations usually persist rules
# information for iptables in /etc/sysconfig/iptables and use the file to
# configure the firewall at startup. As such simply deleting the file will
# be enough to remove any custom configuration from the system
set -o errexit

fw_config_locations=(
    "/etc/sysconfig/iptables"
    "/etc/firewalld/services/*"
    "/etc/firewalld/zones/*"
)

# If using firewalld stop the daemon/service prior to removing the config
if command -v systemctl &>/dev/null; then
    if systemctl is-active firewalld.service &>/dev/null; then
        systemctl stop firewalld.service
    fi
fi

# Include hidden files in globs
shopt -s nullglob dotglob

# Remove any custom configuration
for fw_config in ${fw_config_locations[@]}
do
    rm -rf ${fw_config}
done

exit 0
```
> `command -v systemctl`检查是否存在systemctl命令。整个脚本先停掉防火墙服务，然后清理相关文件。

```bash

```

```bash

```

```bash

```

```bash

```

```bash

```

```bash

```
